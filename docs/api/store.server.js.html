<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns:yui="http://yuilibrary.com/rdf/1.0/yui.rdf#">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<title>API: MojitoServer   store.server.js  (YUI Library)</title>

	<link rel="stylesheet" type="text/css" href="assets/reset-fonts-grids-min.css?stamp=1327685401.85" />
	<link rel="stylesheet" type="text/css" href="assets/api.css?stamp=1327685401.85" />

    <script type="text/javascript" src="assets/api-js?stamp=1327685401.85"></script>
    <script type="text/javascript" src="assets/ac-js?stamp=1327685401.85"></script>
</head>

<body id="yahoo-com">

<div id="doc3" class="yui-t2">
	<div id="hd">
        <h1><a href="http://developer.yahoo.com/yui/" title="mojito">mojito</a></h1>
        <h3>MojitoServer&nbsp; <span class="subtitle">0.1.0</span></h3>
        <a href="./index.html" title="mojito">mojito</a> 
            &gt; <a href="./module_MojitoServer.html" title="MojitoServer">MojitoServer</a>
                
                 &gt; store.server.js (source view) 
        <form onsubmit="return false">
            <div id="propertysearch">
                Search: <input autocomplete="off" id="searchinput" />
                <div id="searchresults">
                    &nbsp;
                </div>
            </div>
        </form>
	</div>

	<div id="bd">
		<div id="yui-main">
			<div class="yui-b">
            <form action="#" name="yui-classopts-form" method="get" id="yui-classopts-form">
                <fieldset>
                    <legend>Filters</legend>
                <span class="classopts"><input type="checkbox" name="show_private" id="show_private" /> <label for="show_private">Show Private</label></span>
                <span class="classopts"><input type="checkbox" name="show_protected" id="show_protected" /> <label for="show_protected">Show Protected</label></span>
                <span class="classopts"><input type="checkbox" name="show_deprecated" id="show_deprecated" /> <label for="show_deprecated">Show Deprecated</label></span>
                </fieldset>
            </form>

                    <div id="srcout">
                        <style>
                            #doc3 .classopts { display:none; }
                        </style>
<div class="highlight"><pre><span class="c">/*</span>
<span class="c"> * Copyright (c) 2011 Yahoo! Inc. All rights reserved.</span>
<span class="c"> */</span>
<span class="c">/**</span>
<span class="c"> * A &quot;resource&quot; is the smallest-sized component in the mojito framework.</span>
<span class="c"> *</span>
<span class="c"> * It has a representation on disk.</span>
<span class="c"> * Sometimes a resource will be fully represented by a single file.</span>
<span class="c"> * Sometimes multiple files together will comprise one resource.</span>
<span class="c"> * Sometimes multiple resources will be defined in one file.</span>
<span class="c"> * It is the job of the resource store to manage all this. </span>
<span class="c"> *</span>
<span class="c"> *</span>
<span class="c"> * RESOURCE TYPES</span>
<span class="c"> *   config      -- a piece of configuration, sometimes for another resource </span>
<span class="c"> *   controller  -- the controller for a mojit</span>
<span class="c"> *   model       -- a model for a mojit</span>
<span class="c"> *   view        -- a view for a mojit</span>
<span class="c"> *   binder      -- a binder for a mojit</span>
<span class="c"> *   action      -- an action to augment the controller</span>
<span class="c"> *   asset       -- an asset (css, js, image, etc)</span>
<span class="c"> *   addon       -- an addon to the mojito system</span>
<span class="c"> *   yui-lang    -- a YUI3 language bundle</span>
<span class="c"> *   yui-module  -- a YUI3 module (that isn&#39;t one of the above)</span>
<span class="c"> *</span>
<span class="c"> *</span>
<span class="c"> * RESOURCE METADATA</span>
<span class="c"> *   (not all resources will have all details)</span>
<span class="c"> *   (not all combinations of type:source are valid)</span>
<span class="c"> *</span>
<span class="c"> *   - id</span>
<span class="c"> *       context-insensitive ID of the resource</span>
<span class="c"> *       (type + &#39;app&#39; + (details specific to type))</span>
<span class="c"> *       (type + &#39;mojit&#39; + mojit-type + (details specific to type))</span>
<span class="c"> *</span>
<span class="c"> *   - type</span>
<span class="c"> *       see above</span>
<span class="c"> *</span>
<span class="c"> *   - source</span>
<span class="c"> *       `fw`, `app` or `mojit`</span>
<span class="c"> *       where the resource is defined</span>
<span class="c"> *</span>
<span class="c"> *   - fsPath</span>
<span class="c"> *       the path on the filesystem</span>
<span class="c"> *</span>
<span class="c"> *   - staticHandlerURL</span>
<span class="c"> *       for resources that can be deployed by reference to the client</span>
<span class="c"> *       the URL that will cause the asset handler to serve the resource</span>
<span class="c"> *</span>
<span class="c"> *   - name</span>
<span class="c"> *       specific to type</span>
<span class="c"> *</span>
<span class="c"> *   - configType</span>
<span class="c"> *       for type=config</span>
<span class="c"> *       the type of the configuration</span>
<span class="c"> *</span>
<span class="c"> *   - viewEngine</span>
<span class="c"> *       for type=view</span>
<span class="c"> *       `mu`, `dust`, etc</span>
<span class="c"> *</span>
<span class="c"> *   - viewOutputFormat</span>
<span class="c"> *       for type=view</span>
<span class="c"> *       output format that the view will generate</span>
<span class="c"> *       `xml`, `html`, etc</span>
<span class="c"> *</span>
<span class="c"> *   - assetType</span>
<span class="c"> *       for type=asset</span>
<span class="c"> *       `css`, `js`, `png`, `swf`, etc</span>
<span class="c"> *</span>
<span class="c"> *   - addonType</span>
<span class="c"> *       for type=addon</span>
<span class="c"> *       the mojito subsystem to which the addon should be added</span>
<span class="c"> *</span>
<span class="c"> *   - yuiModuleName</span>
<span class="c"> *       for any resource delivered as a YUI3 module</span>
<span class="c"> *       the YUI3 module name</span>
<span class="c"> *</span>
<span class="c"> *   - yuiModuleVersion</span>
<span class="c"> *       for any resource delivered as a YUI3 module</span>
<span class="c"> *       the YUI3 module version</span>
<span class="c"> *</span>
<span class="c"> *   - yuiModuleMeta</span>
<span class="c"> *       for any resource delivered as a YUI3 module</span>
<span class="c"> *       the YUI3 module metadata</span>
<span class="c"> *       (requires, langs, etc)</span>
<span class="c"> *</span>
<span class="c"> *   - yuiSortedPaths</span>
<span class="c"> *       for any resource delivered as a YUI3 module</span>
<span class="c"> *       a list of YUI modules required by the module,</span>
<span class="c"> *       with transitive dependencies resolved</span>
<span class="c"> *       format:  { yui-module-name: URL-to-load-yui-module }</span>
<span class="c"> *      </span>
<span class="c"> *</span>
<span class="c"> *</span>
<span class="c"> * @class ServerStore</span>
<span class="c"> * @constructor</span>
<span class="c"> * @param root</span>
<span class="c"> * @private</span>
<span class="c"> */</span>

<span class="kd">var</span> <span class="nx">libfs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span><span class="o">,</span>
    <span class="nx">libpath</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span><span class="o">,</span>
    <span class="nx">libqs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;querystring&#39;</span><span class="p">)</span><span class="o">,</span>
    <span class="nx">libvm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;vm&#39;</span><span class="p">)</span><span class="o">,</span>
    <span class="nx">libglob</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./glob&#39;</span><span class="p">)</span><span class="o">,</span>
    <span class="nx">libycb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./libs/ycb&#39;</span><span class="p">)</span><span class="o">,</span>

    <span class="nx">isPositiveInt</span> <span class="o">=</span> <span class="sr">/^[0-9]+$/</span><span class="o">,</span>
    <span class="nx">isSpaceOpencurly</span> <span class="o">=</span> <span class="sr">/ \{/g</span><span class="o">,</span>
    <span class="nx">isSpaceClosecurly</span> <span class="o">=</span> <span class="sr">/ \}/g</span><span class="o">,</span>


    <span class="c">// fallback logger</span>
    <span class="nx">logger</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">log</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="o">,</span> <span class="nx">lvl</span><span class="o">,</span> <span class="nx">who</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="o">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">lvl</span> <span class="o">===</span> <span class="s2">&quot;warn&quot;</span> <span class="o">||</span> <span class="nx">lvl</span> <span class="o">===</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="c">// console.warn provides unbuffered output and avoids message</span>
                <span class="c">// truncation when process.exit() is called after logging</span>
                <span class="nx">log</span> <span class="o">=</span> <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="o">;</span>
            <span class="p">}</span>
            <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="nx">lvl</span><span class="o">+</span><span class="s1">&#39;] &#39;</span><span class="o">+</span><span class="nx">who</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="o">+</span><span class="nx">msg</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="nx">YUI</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;yui3&#39;</span><span class="p">).</span><span class="nx">YUI</span><span class="o">,</span>

    <span class="c">// re-requiring seems to be necessary if useSync() will be called on both.</span>
    <span class="c">// if removed and YUI used instead an error is thrown on page load</span>
    <span class="nx">YUI2</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;yui3&#39;</span><span class="p">).</span><span class="nx">YUI</span><span class="o">,</span>

    <span class="nx">mojitoRoot</span> <span class="o">=</span> <span class="nx">__dirname</span><span class="o">,</span>

    <span class="nx">NAME</span> <span class="o">=</span> <span class="s1">&#39;MojitoServer&#39;</span><span class="o">;</span>

<span class="c">// TODO 2011-06-16: move string constants here</span>


<span class="kd">function</span> <span class="nx">Affinity</span><span class="p">(</span><span class="nx">affinity</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_init</span><span class="p">(</span><span class="nx">affinity</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">Affinity</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">_init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">aff</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">parts</span><span class="o">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">aff</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">affinity</span> <span class="o">=</span> <span class="nx">aff</span><span class="o">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">parts</span> <span class="o">=</span> <span class="nx">aff</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">affinity</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="o">,</span>
    <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">affinity</span><span class="o">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c">/*</span>
<span class="c"> *   * root string</span>
<span class="c"> *       directory of the application</span>
<span class="c"> *   * libs object</span>
<span class="c"> *       set of libraries to use</span>
<span class="c"> *       - ycb:  YCB library to use, if available</span>
<span class="c"> *       - fs:   filesystem library to use during unittesting</span>
<span class="c"> *</span>
<span class="c"> */</span>
<span class="kd">function</span> <span class="nx">ServerStore</span><span class="p">(</span><span class="nx">root</span><span class="o">,</span> <span class="nx">libs</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">//logger.log(&#39;ctor(&#39; + root + &#39;)&#39;);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_root</span> <span class="o">=</span> <span class="nx">root</span><span class="o">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_version</span> <span class="o">=</span> <span class="s1">&#39;0.1.0&#39;</span><span class="o">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_shortRoot</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span> <span class="o">=</span> <span class="nx">libs</span> <span class="o">||</span> <span class="p">{};</span>

    <span class="c">// no-context version of the appConfig</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="c">// each of these is [resid][affinity].contexts</span>
    <span class="c">//                  [resid][affinity][ctx] = { parts }</span>
    <span class="c">// mojits have [type] prefixed</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">fwMeta</span><span class="o">:</span> <span class="p">{}</span><span class="o">,</span>
        <span class="nx">appMeta</span><span class="o">:</span> <span class="p">{}</span><span class="o">,</span>
        <span class="nx">mojitMeta</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_staticURLs</span> <span class="o">=</span> <span class="p">{};</span>      <span class="c">// url =&gt; fullpath</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_dynamicURLs</span> <span class="o">=</span> <span class="p">{};</span>     <span class="c">// url =&gt; dynamic content</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_mojitAssetRoots</span> <span class="o">=</span> <span class="p">{};</span> <span class="c">// mojitType =&gt; URL prefix</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_mojitLangs</span> <span class="o">=</span> <span class="p">{};</span>      <span class="c">// mojitType =&gt; [en-US,en-GB,en]</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_mojitPaths</span> <span class="o">=</span> <span class="p">{};</span>      <span class="c">// mojitType =&gt; filesystem directory of mojit</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_fwMeta</span> <span class="o">=</span> <span class="p">{};</span>              <span class="c">// [env][ctx][resid] = { parts }</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span> <span class="o">=</span> <span class="p">{};</span>             <span class="c">// [env][ctx][resid] = { parts }</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span> <span class="o">=</span> <span class="p">{};</span>           <span class="c">// [env][type][ctx][resid] = { parts }</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiRequired</span> <span class="o">=</span> <span class="p">{};</span>    <span class="c">// [env][type][ctx] = [ list of YUI module names ]</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span> <span class="o">=</span> <span class="p">{};</span>      <span class="c">// [env][type][ctx] = [ list of YUI module names ]</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSortedPaths</span> <span class="o">=</span> <span class="p">{};</span> <span class="c">// [env][type][ctx][module] = path</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_configCache</span> <span class="o">=</span> <span class="p">{};</span>         <span class="c">// fullpath: content</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_ycbCache</span> <span class="o">=</span> <span class="p">{};</span>            <span class="c">// fullpath: ycb config object</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_expandInstanceCache</span> <span class="o">=</span> <span class="p">{</span>   <span class="c">// [env][cacheKey] = instance</span>
        <span class="nx">client</span><span class="o">:</span> <span class="p">{}</span><span class="o">,</span>
        <span class="nx">server</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_Y</span> <span class="o">=</span> <span class="nx">YUI2</span><span class="p">().</span><span class="nx">useSync</span><span class="p">(</span><span class="s1">&#39;intl&#39;</span><span class="p">);</span>

    <span class="c">// TODO 2011-06-16: bake this into the refactor</span>
    <span class="c">// this stuff is mainly so that we can send mocks during testing</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">fs</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">fs</span> <span class="o">=</span> <span class="nx">libfs</span><span class="o">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="o">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">libycb</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">ycb</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">ycb</span> <span class="o">=</span> <span class="nx">libycb</span><span class="o">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">ServerStore</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>

    <span class="c">// ===========================================</span>
    <span class="c">// ================== PUBLIC =================</span>


    <span class="c">/**</span>
<span class="c">     * Preloads everything in the app, and as well pertinent parts of</span>
<span class="c">     * the framework.</span>
<span class="c">     * @method preload</span>
<span class="c">     * @applicationEnvironment ??</span>
<span class="c">     * @appConfig overrides for the app config</span>
<span class="c">     * @return {undefined}</span>
<span class="c">     */</span>
    <span class="nx">preload</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">applicationEnvironment</span><span class="o">,</span> <span class="nx">appConfig</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">//logger.log(&#39;preload()&#39;);</span>
        <span class="kd">var</span> <span class="nx">type</span><span class="o">,</span> <span class="nx">ctxKey</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">n</span><span class="o">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">)</span> <span class="p">{</span>
            <span class="c">// we&#39;ve already been preloaded</span>
            <span class="c">// This situation mainly happens in the commandline scripts.</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_fwConfig</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_readConfigJSON</span><span class="p">(</span><span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">mojitoRoot</span><span class="o">,</span> <span class="s1">&#39;config.json&#39;</span><span class="p">));</span>

        <span class="c">// TODO:  use applicationEnvironment while reading, so that env=x</span>
        <span class="c">//        contextualization in the application.json takes effect</span>
        <span class="c">// need to read the non-context appConfig now so that values are available during</span>
        <span class="c">// generation of the static URLs</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_readAppConfigNC</span><span class="p">();</span>
        
        <span class="c">// generates URL&#39;s about each spec in application.json</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_urlsForAppSpecs</span><span class="p">();</span>

        <span class="c">// TODO: [bug 4647260] allow the environment to be overridden within the app config</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">env</span> <span class="o">=</span> <span class="nx">applicationEnvironment</span> <span class="o">||</span> <span class="s1">&#39;dev&#39;</span><span class="o">;</span>

        <span class="c">// merge app configuration overrides</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">appConfig</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">n</span> <span class="k">in</span> <span class="nx">appConfig</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">appConfig</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;overriding application config value: &#39;</span> <span class="o">+</span> <span class="nx">n</span><span class="o">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">);</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">appConfig</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c">// generates metadata about each file</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadMeta</span><span class="p">();</span>
        
        <span class="c">// takes the preloaded info and resolves affinity, etc</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_cookdown</span><span class="p">();</span>

        <span class="c">// preread configs</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_prereadConfigs</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">.</span><span class="nx">server</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">type</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">.</span><span class="nx">server</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">_prereadConfigs</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">.</span><span class="nx">server</span><span class="p">[</span><span class="nx">type</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;precomputed&#39;</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">dependencyCalculations</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_precalcYuiDependencies</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c">// binders are client-side-only constructs, yet we need to know about</span>
        <span class="c">// them when talking about the &#39;server&#39; environment</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">type</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">.</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span> <span class="p">{</span>

                <span class="k">for</span> <span class="p">(</span><span class="nx">ctxKey</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">.</span><span class="nx">client</span><span class="p">[</span><span class="nx">type</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">.</span><span class="nx">client</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">ctxKey</span><span class="p">))</span> <span class="p">{</span>

                        <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">.</span><span class="nx">client</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">])</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">.</span><span class="nx">client</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                                <span class="nx">res</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">.</span><span class="nx">client</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">][</span><span class="nx">resid</span><span class="p">];</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;binder&#39;</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="k">continue</span><span class="o">;</span>
                                <span class="p">}</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">.</span><span class="nx">server</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">][</span><span class="nx">resid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="o">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="nx">setLogger</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logger</span> <span class="o">=</span> <span class="nx">l</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="c">/*</span>
<span class="c">     * TODO: RIC [bug 4647265]</span>
<span class="c">     */</span>
    <span class="nx">getSpec</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">id</span><span class="o">,</span> <span class="nx">context</span><span class="o">,</span> <span class="nx">callback</span><span class="p">){</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">expandInstanceForEnv</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="p">{</span><span class="nx">base</span><span class="o">:</span> <span class="nx">id</span><span class="p">}</span><span class="o">,</span> <span class="nx">context</span><span class="o">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="o">,</span> <span class="nx">obj</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="p">}</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">env</span> <span class="o">===</span> <span class="s1">&#39;client&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">){</span>
                <span class="nx">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">assets</span><span class="o">;</span>
            <span class="p">}</span>

            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="o">,</span> <span class="nx">obj</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="c">/*</span>
<span class="c">     * TODO: RIC [bug 4647330]</span>
<span class="c">     */</span>
    <span class="nx">getType</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">type</span><span class="o">,</span> <span class="nx">context</span><span class="o">,</span> <span class="nx">callback</span><span class="p">){</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">expandInstanceForEnv</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">}</span><span class="o">,</span> <span class="nx">context</span><span class="o">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="o">,</span> <span class="nx">obj</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="p">}</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">env</span> <span class="o">===</span> <span class="s1">&#39;client&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">){</span>
                <span class="nx">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">assets</span><span class="o">;</span>
            <span class="p">}</span>

            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="o">,</span> <span class="nx">obj</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="c">/**</span>
<span class="c">     * This just calls expandInstanceForEnv() with `env` set to `server`.</span>
<span class="c">     *</span>
<span class="c">     * @method expandInstance</span>
<span class="c">     * @param instance {map} partial instance to expand</span>
<span class="c">     * @param ctx {object} the request context</span>
<span class="c">     * @param cb {function(err,instance)} the callback to send the results to</span>
<span class="c">     * @return nothing. results passed back via the callback</span>
<span class="c">     */</span>
    <span class="nx">expandInstance</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">instance</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">expandInstanceForEnv</span><span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="o">,</span> <span class="nx">instance</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">cb</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="c">/**</span>
<span class="c">     * This method takes a partial instance and expands it to all details needed to run the mojit.</span>
<span class="c">     *</span>
<span class="c">     * Only a `base` or `type` fields are required.  You should only specify one.</span>
<span class="c">     *</span>
<span class="c">     * &lt;pre&gt;</span>
<span class="c">     *  instance: {</span>
<span class="c">     *      base: &quot;&quot;,</span>
<span class="c">     *          // specifies a &quot;base&quot; instance which this instance will extend</span>
<span class="c">     *          // the value refers to a key of `specs` found in `application.json`</span>
<span class="c">     *      type: &quot;&quot;,</span>
<span class="c">     *          // specifies the mojit type</span>
<span class="c">     *      action: &quot;&quot;,</span>
<span class="c">     *          // specifies a default action if the instance isn&#39;t dispatched with a specific one</span>
<span class="c">     *      config: {...},</span>
<span class="c">     *          // the config for the mojit</span>
<span class="c">     *          // this will be augmented (appropriately) with the mojit type defaults</span>
<span class="c">     *          // found in the type&#39;s `defaults.json`</span>
<span class="c">     *      appConfig: {...},</span>
<span class="c">     *          // the application config (appropriate for the context)</span>
<span class="c">     *      assetRoot: &quot;&quot;,</span>
<span class="c">     *          // path to directory containing assets</span>
<span class="c">     *          // the path will be a URL if `env` is `client` otherwise it&#39;s a filesystem path</span>
<span class="c">     *      definition: &quot;&quot;,</span>
<span class="c">     *          // the body of the `defintion.json` for the mojit type</span>
<span class="c">     *      defaults: &quot;&quot;,</span>
<span class="c">     *          // the body of the `defaults.json` for the mojit type</span>
<span class="c">     *      yui: {</span>
<span class="c">     *          // details for generating a YUI sandbox for this instance</span>
<span class="c">     *          config: {</span>
<span class="c">     *              // configuration details for the YUI.GlobalConfig.groups (or an equivalent).</span>
<span class="c">     *              // the module paths are given as `fullpath` and contain either a URL if `env&#39;</span>
<span class="c">     *              // is `client` or a filesystem path if `env` is `server`</span>
<span class="c">     *          },</span>
<span class="c">     *          requires: []</span>
<span class="c">     *              // list of YUI modules that this instance requires</span>
<span class="c">     *      },</span>
<span class="c">     *      actions: [],</span>
<span class="c">     *          // list of paths to the YUI modules containing actions</span>
<span class="c">     *      controller: &quot;&quot;,</span>
<span class="c">     *          // path to controller</span>
<span class="c">     *          // the path will be a URL if `env` is `client` otherwise it&#39;s a filesystem path</span>
<span class="c">     *      lang:</span>
<span class="c">     *          // path to YUI module of the language bundle</span>
<span class="c">     *          // the path will be a URL if `env` is `client` otherwise it&#39;s a filesystem path</span>
<span class="c">     *      models: {},</span>
<span class="c">     *          // list of models used by the mojit type</span>
<span class="c">     *          // the key is the model name, and the value is the path to the model file</span>
<span class="c">     *          // the path will be a URL if `env` is `client` otherwise it&#39;s a filesystem path</span>
<span class="c">     *      views: {</span>
<span class="c">     *          // list of views in the mojit type</span>
<span class="c">     *          // the key is the view name, and the value is details about the view</span>
<span class="c">     *          view-name: {</span>
<span class="c">     *              &quot;content-path&quot;: &quot;&quot;,</span>
<span class="c">     *                  // the path to use to load the body of the view</span>
<span class="c">     *                  // the path will be a URL if `env` is `client` otherwise it&#39;s a filesystem path</span>
<span class="c">     *              &quot;engine&quot;: &quot;&quot;,</span>
<span class="c">     *                  // which engine is used to render the view</span>
<span class="c">     *              &quot;binder-path&quot;: &quot;&quot;,</span>
<span class="c">     *                  // the path to the binder</span>
<span class="c">     *                  // the path will be a URL if `env` is `client` otherwise it&#39;s a filesystem path</span>
<span class="c">     *              &quot;binder-module&quot;: &quot;&quot;</span>
<span class="c">     *                  // the YUI module name of the binder</span>
<span class="c">     *          }</span>
<span class="c">     *      }</span>
<span class="c">     *  }</span>
<span class="c">     * &lt;/pre&gt;</span>
<span class="c">     *</span>
<span class="c">     * @method expandInstanceForEnv</span>
<span class="c">     * @param env {&quot;client&quot;|&quot;server&quot;} which environment to expand the instance for</span>
<span class="c">     * @param instance {map} partial instance to expand</span>
<span class="c">     * @param ctx {object} the request context</span>
<span class="c">     * @param cb {function(err,instance)} the callback to send the results to</span>
<span class="c">     * @return nothing. results passed back via the callback</span>
<span class="c">     */</span>
    <span class="nx">expandInstanceForEnv</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">instance</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">//logger.log(&#39;expandInstanceForEnv(&#39; + env + &#39;,&#39; + (instance.id||&#39;@&#39;+instance.type) + &#39;)&#39;);</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="o">,</span> <span class="nx">base</span><span class="o">,</span>
            <span class="nx">appConfig</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getAppConfig</span><span class="p">(</span><span class="nx">ctx</span><span class="o">,</span> <span class="s1">&#39;definition&#39;</span><span class="p">)</span><span class="o">,</span>
            <span class="nx">cacheKey</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span><span class="o">,</span>
            <span class="nx">cacheValue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_expandInstanceCache</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">cacheKey</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">cacheValue</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cloneObj</span><span class="p">(</span><span class="nx">cacheValue</span><span class="p">));</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">gotBase</span><span class="p">(</span><span class="nx">out</span><span class="o">,</span> <span class="nx">fromBase</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">spec</span><span class="o">;</span>

            <span class="c">// type details rebuilt every time</span>
            <span class="nx">delete</span> <span class="nx">out</span><span class="p">.</span><span class="nx">actions</span><span class="o">;</span>
            <span class="nx">delete</span> <span class="nx">out</span><span class="p">.</span><span class="nx">assetsRoot</span><span class="o">;</span>
            <span class="nx">delete</span> <span class="nx">out</span><span class="p">.</span><span class="nx">assets</span><span class="o">;</span>
            <span class="nx">delete</span> <span class="nx">out</span><span class="p">.</span><span class="nx">controller</span><span class="o">;</span>
            <span class="nx">delete</span> <span class="nx">out</span><span class="p">.</span><span class="nx">defaults</span><span class="o">;</span>
            <span class="nx">delete</span> <span class="nx">out</span><span class="p">.</span><span class="nx">definition</span><span class="o">;</span>
            <span class="nx">delete</span> <span class="nx">out</span><span class="p">.</span><span class="nx">models</span><span class="o">;</span>
            <span class="nx">delete</span> <span class="nx">out</span><span class="p">.</span><span class="nx">views</span><span class="o">;</span>
            <span class="nx">delete</span> <span class="nx">out</span><span class="p">.</span><span class="nx">yui</span><span class="o">;</span>

            <span class="nx">out</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="nx">out</span><span class="p">.</span><span class="nx">config</span> <span class="o">||</span> <span class="p">{};</span>
            <span class="nx">out</span><span class="p">.</span><span class="nx">action</span> <span class="o">=</span> <span class="nx">out</span><span class="p">.</span><span class="nx">action</span> <span class="o">||</span> <span class="s1">&#39;index&#39;</span><span class="o">;</span>
            <span class="nx">out</span><span class="p">.</span><span class="nx">guid</span> <span class="o">=</span> <span class="nx">out</span><span class="p">.</span><span class="nx">guid</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_Y</span><span class="p">.</span><span class="nx">guid</span><span class="p">();</span>

            <span class="k">try</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">getMojitTypeDetails</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">out</span><span class="p">.</span><span class="nx">type</span><span class="o">,</span> <span class="nx">out</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c">// apply type defaults to config</span>
            <span class="k">if</span> <span class="p">((</span><span class="o">!</span> <span class="nx">fromBase</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">out</span><span class="p">.</span><span class="nx">defaults</span> <span class="o">&amp;&amp;</span> <span class="nx">out</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">spec</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_cloneObj</span><span class="p">(</span><span class="nx">out</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">config</span><span class="p">);</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">_mergeRecursive</span><span class="p">(</span><span class="nx">spec</span><span class="o">,</span> <span class="nx">out</span><span class="p">.</span><span class="nx">config</span><span class="p">);</span>
                <span class="nx">out</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="nx">spec</span><span class="o">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">out</span><span class="p">.</span><span class="nx">appConfig</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">out</span><span class="p">.</span><span class="nx">appConfig</span> <span class="o">=</span> <span class="nx">appConfig</span><span class="o">;</span>
                <span class="nx">delete</span> <span class="nx">out</span><span class="p">.</span><span class="nx">appConfig</span><span class="p">.</span><span class="nx">specs</span><span class="o">;</span>
            <span class="p">}</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">_expandInstanceCache</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">cacheKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_cloneObj</span><span class="p">(</span><span class="nx">out</span><span class="p">);</span>
            <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="o">,</span> <span class="nx">out</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">base</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">appConfig</span><span class="p">.</span><span class="nx">specs</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">base</span> <span class="o">=</span> <span class="nx">appConfig</span><span class="p">.</span><span class="nx">specs</span><span class="p">[</span><span class="nx">instance</span><span class="p">.</span><span class="nx">base</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">base</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Unknown &quot;base&quot; of &quot;&#39;</span> <span class="o">+</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">base</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="c">// The base will need to carry it&#39;s ID with it.</span>
            <span class="nx">base</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">base</span><span class="o">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">expandInstanceForEnv</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">base</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="o">,</span> <span class="nx">baseInstance</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nx">baseInstance</span><span class="o">;</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">_mergeRecursive</span><span class="p">(</span><span class="nx">temp</span><span class="o">,</span> <span class="nx">instance</span><span class="p">);</span>
                <span class="nx">gotBase</span><span class="p">(</span><span class="nx">temp</span><span class="o">,</span> <span class="kc">true</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">gotBase</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_cloneObj</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span><span class="o">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">/**</span>
<span class="c">     * gets application configuration</span>
<span class="c">     *</span>
<span class="c">     * @method getAppConfig</span>
<span class="c">     * @param context {object} context under which to load the config</span>
<span class="c">     * @param name {string} type of config to read:</span>
<span class="c">     * - definition:  reads ./application.json</span>
<span class="c">     * - package:  reads ./package.json</span>
<span class="c">     * - routes:  reads ./routes.json (or whatever was configured in appConfig(&#39;definition&#39;).routesFiles)</span>
<span class="c">     * @return {object} config object</span>
<span class="c">     */</span>
    <span class="nx">getAppConfig</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="o">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">//logger.log(&#39;getAppConfig(&#39;+name+&#39;)&#39;);</span>
        <span class="kd">var</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;definition&#39;</span> <span class="o">===</span> <span class="nx">name</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="o">!</span><span class="nx">ctx</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">length</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cloneObj</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">resid</span> <span class="o">=</span> <span class="s1">&#39;config-&#39;</span> <span class="o">+</span> <span class="nx">name</span><span class="o">;</span>
        <span class="nx">res</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getContextualizedResource</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">.</span><span class="nx">server</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">resid</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_readConfigYCB</span><span class="p">(</span><span class="nx">ctx</span><span class="o">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">/**</span>
<span class="c">     * Returns the routes configured in the application.</span>
<span class="c">     * @param ctx {object} context under which to load the routes</span>
<span class="c">     * @return {object} routes</span>
<span class="c">     */</span>
    <span class="nx">getRoutes</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">//logger.log(&#39;getRoutes()&#39;);</span>
        <span class="kd">var</span> <span class="nx">ress</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span>
            <span class="nx">r</span><span class="o">,</span> <span class="nx">routes</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="c">// TODO: [bug 4647333] trapped this error. It only appears when there is no application.json</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">ress</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getResourceListForContext</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">.</span><span class="nx">server</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="c">//logger.log(err);</span>
            <span class="nx">ress</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="nx">ress</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">ress</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">res</span> <span class="o">=</span> <span class="nx">ress</span><span class="p">[</span><span class="nx">resid</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;routes&#39;</span> <span class="o">!==</span> <span class="nx">res</span><span class="p">.</span><span class="nx">configType</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="p">}</span>
                <span class="nx">r</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_readConfigYCB</span><span class="p">(</span><span class="nx">ctx</span><span class="o">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">_mergeRecursive</span><span class="p">(</span><span class="nx">routes</span><span class="o">,</span> <span class="nx">r</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">routes</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">routes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cloneObj</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_fwConfig</span><span class="p">.</span><span class="nx">defaultRoutes</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">routes</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">/*</span>
<span class="c">     *  * url string</span>
<span class="c">     *      asset URL</span>
<span class="c">     *  * returns</span>
<span class="c">     *      filesystemm path</span>
<span class="c">     */</span>
    <span class="c">// TODO DOCS [bug 4647336]</span>
    <span class="nx">fileFromStaticHandlerURL</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">//logger.log(&#39;fileFromStaticHandlerURL(&#39;+url+&#39;)&#39;);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_staticURLs</span><span class="p">[</span><span class="nx">url</span><span class="p">];</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// TODO DOCS [bug 4647349]</span>
    <span class="nx">getYuiConfigAllMojits</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">// TODO DREW -- use getMojitTypeDetails() to generate this</span>
        <span class="c">//logger.log(&#39;getYuiConfigAllMojits(&#39;+env+&#39;)&#39;);</span>
        <span class="kd">var</span> <span class="nx">modules</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span> <span class="nx">type</span><span class="o">,</span>
            <span class="nx">ress</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">ctxKey</span><span class="o">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">type</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">ress</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getResourceListForContext</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">type</span><span class="p">]</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="nx">ress</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">ress</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">res</span> <span class="o">=</span> <span class="nx">ress</span><span class="p">[</span><span class="nx">resid</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">continue</span><span class="o">;</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;fw&#39;</span> <span class="o">===</span> <span class="nx">res</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">continue</span><span class="o">;</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;app&#39;</span> <span class="o">===</span> <span class="nx">res</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">continue</span><span class="o">;</span>
                        <span class="p">}</span>
                        <span class="nx">modules</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="nx">fullpath</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;client&#39;</span> <span class="o">===</span> <span class="nx">env</span><span class="p">)</span> <span class="o">?</span> <span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span> <span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">,</span>
                            <span class="nx">requires</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleMeta</span><span class="p">.</span><span class="nx">requires</span>
                        <span class="p">};</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="c">// add all langs</span>
                <span class="nx">ress</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getLangList</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">type</span><span class="p">]);</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="nx">ress</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">ress</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">res</span> <span class="o">=</span> <span class="nx">ress</span><span class="p">[</span><span class="nx">resid</span><span class="p">];</span>
                        <span class="nx">modules</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="nx">fullpath</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;client&#39;</span> <span class="o">===</span> <span class="nx">env</span><span class="p">)</span> <span class="o">?</span> <span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span> <span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">,</span>
                            <span class="nx">requires</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleMeta</span><span class="p">.</span><span class="nx">requires</span>
                        <span class="p">};</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="nx">modules</span><span class="o">:</span> <span class="nx">modules</span><span class="p">};</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// TODO DOCS [bug 4647354]</span>
    <span class="nx">getYuiConfigFw</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">//logger.log(&#39;getYuiConfigFw(&#39;+env+&#39;)&#39;);</span>
        <span class="kd">var</span> <span class="nx">modules</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">ress</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_fwMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span><span class="nx">modules</span><span class="o">:</span> <span class="p">{}};</span>
        <span class="p">}</span>
        <span class="nx">ress</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getResourceListForContext</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_fwMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">]</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="nx">ress</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">ress</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">res</span> <span class="o">=</span> <span class="nx">ress</span><span class="p">[</span><span class="nx">resid</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="p">}</span>
                <span class="nx">modules</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">fullpath</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;client&#39;</span> <span class="o">===</span> <span class="nx">env</span><span class="p">)</span> <span class="o">?</span> <span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span> <span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">,</span>
                    <span class="nx">requires</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleMeta</span><span class="p">.</span><span class="nx">requires</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">modules</span><span class="o">:</span> <span class="nx">modules</span><span class="p">};</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// TODO DOCS [bug 4647357]</span>
    <span class="nx">getYuiConfigApp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">//logger.log(&#39;getYuiConfigApp(&#39;+env+&#39;)&#39;);</span>
        <span class="kd">var</span> <span class="nx">modules</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">ress</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span><span class="nx">modules</span><span class="o">:</span> <span class="p">{}};</span>
        <span class="p">}</span>
        <span class="nx">ress</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getResourceListForContext</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">]</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="nx">ress</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">ress</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">res</span> <span class="o">=</span> <span class="nx">ress</span><span class="p">[</span><span class="nx">resid</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="p">}</span>
                <span class="nx">modules</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">fullpath</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;client&#39;</span> <span class="o">===</span> <span class="nx">env</span><span class="p">)</span> <span class="o">?</span> <span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span> <span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">,</span>
                    <span class="nx">requires</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleMeta</span><span class="p">.</span><span class="nx">requires</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">modules</span><span class="o">:</span> <span class="nx">modules</span><span class="p">};</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">/*</span>
<span class="c">     * FUTURE: [bug 4647365] Cache the output of this function</span>
<span class="c">     * returns a serializeable object (for passing JSON)</span>
<span class="c">     * cache key:  all of ctx</span>
<span class="c">     *</span>
<span class="c">     * @method serializeClientStore</span>
<span class="c">     * @param context {object}</span>
<span class="c">     * @param instance {list} list of instances to deploy to the client</span>
<span class="c">     *                  (only instances with IDs will be deployable)</span>
<span class="c">     */</span>
    <span class="nx">serializeClientStore</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="o">,</span> <span class="nx">instances</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">//logger.log(&#39;serializeClientStore()&#39;);</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="o">,</span> <span class="nx">id</span><span class="o">,</span> <span class="nx">instance</span><span class="o">,</span> <span class="nx">type</span><span class="o">,</span> <span class="nx">types</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">out</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">appConfig</span><span class="o">:</span> <span class="p">{}</span><span class="o">,</span>
                <span class="nx">specs</span><span class="o">:</span> <span class="p">{}</span><span class="o">,</span>  <span class="c">// instance details</span>
                <span class="nx">mojits</span><span class="o">:</span> <span class="p">{}</span><span class="o">,</span> <span class="c">// type details</span>
                <span class="nx">routes</span><span class="o">:</span> <span class="p">{}</span>
            <span class="p">};</span>

        <span class="nx">out</span><span class="p">.</span><span class="nx">appConfig</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getAppConfig</span><span class="p">(</span><span class="nx">ctx</span><span class="o">,</span> <span class="s1">&#39;definition&#39;</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">instances</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">instance</span> <span class="o">=</span> <span class="nx">instances</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="nx">types</span><span class="p">[</span><span class="nx">instance</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="nx">id</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">id</span><span class="o">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">out</span><span class="p">.</span><span class="nx">specs</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">out</span><span class="p">.</span><span class="nx">appConfig</span><span class="p">.</span><span class="nx">specs</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">type</span> <span class="k">in</span> <span class="nx">types</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">types</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">out</span><span class="p">.</span><span class="nx">mojits</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">getMojitTypeDetails</span><span class="p">(</span><span class="s1">&#39;client&#39;</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">type</span><span class="o">,</span> <span class="nx">out</span><span class="p">.</span><span class="nx">mojits</span><span class="p">[</span><span class="nx">type</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">out</span><span class="p">.</span><span class="nx">routes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getRoutes</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>

        <span class="c">// these aren&#39;t needed on the client</span>
        <span class="nx">delete</span> <span class="nx">out</span><span class="p">.</span><span class="nx">appConfig</span><span class="p">.</span><span class="nx">mojitsDirs</span><span class="o">;</span>
        <span class="nx">delete</span> <span class="nx">out</span><span class="p">.</span><span class="nx">appConfig</span><span class="p">.</span><span class="nx">routesFiles</span><span class="o">;</span>
        <span class="nx">delete</span> <span class="nx">out</span><span class="p">.</span><span class="nx">appConfig</span><span class="p">.</span><span class="nx">specs</span><span class="o">;</span>

        <span class="k">return</span> <span class="nx">out</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="nx">listAllMojits</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="p">){</span>
        
        <span class="kd">var</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">list</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">mojitType</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">mojitType</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mojitType</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">list</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="nx">getAllMojits</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">){</span>

        <span class="kd">var</span> <span class="nx">mojits</span><span class="o">,</span> <span class="nx">mojit</span><span class="o">,</span> <span class="nx">list</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">ctx</span><span class="p">){</span>
            <span class="nx">ctx</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>

        <span class="nx">mojits</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">listAllMojits</span><span class="p">(</span><span class="nx">env</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">mojit</span> <span class="k">in</span> <span class="nx">mojits</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">mojits</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">mojit</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">list</span><span class="p">[</span><span class="nx">mojits</span><span class="p">[</span><span class="nx">mojit</span><span class="p">]]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getMojitTypeDetails</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">mojits</span><span class="p">[</span><span class="nx">mojit</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">list</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">/*</span>
<span class="c">     * Find the best match for a context, considering context language. Falls</span>
<span class="c">     * back to the first match found if there is no suitable language.</span>
<span class="c">     *</span>
<span class="c">     * @param {object} currentContext</span>
<span class="c">     * @param {object} contexts a mapping of context key to context</span>
<span class="c">     * @return {string} null or the context key of the best match</span>
<span class="c">     */</span>
    <span class="nx">_findBestContext</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">currentContext</span><span class="o">,</span> <span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">availableLangs</span> <span class="o">=</span> <span class="p">[]</span><span class="o">,</span>
            <span class="nx">bestCtxKey</span><span class="o">,</span>
            <span class="nx">bestLang</span><span class="o">,</span>
            <span class="nx">context</span><span class="o">,</span>
            <span class="nx">ctxKey</span><span class="o">,</span>
            <span class="nx">i</span><span class="o">,</span>
            <span class="nx">matchingKeys</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="c">// Collect languages from matching contexts</span>
        <span class="c">// We&#39;re done if we find an exact match</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">ctxKey</span> <span class="k">in</span> <span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">contexts</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">ctxKey</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">context</span> <span class="o">=</span> <span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_matchContext</span><span class="p">(</span><span class="nx">currentContext</span><span class="o">,</span> <span class="nx">context</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">lang</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">currentContext</span><span class="p">.</span><span class="nx">lang</span> <span class="o">===</span> <span class="nx">context</span><span class="p">.</span><span class="nx">lang</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">bestCtxKey</span> <span class="o">=</span> <span class="nx">ctxKey</span><span class="o">;</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="p">}</span>
                        <span class="nx">availableLangs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">lang</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="nx">matchingKeys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">ctxKey</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c">// If no exact match, find the next best language</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">bestCtxKey</span> <span class="o">&amp;&amp;</span> <span class="nx">availableLangs</span> <span class="o">&amp;&amp;</span> <span class="nx">availableLangs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">currentContext</span> <span class="o">&amp;&amp;</span> <span class="nx">currentContext</span><span class="p">.</span><span class="nx">lang</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">bestLang</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_Y</span><span class="p">.</span><span class="nx">Intl</span><span class="p">.</span><span class="nx">lookupBestLang</span><span class="p">(</span><span class="nx">currentContext</span><span class="p">.</span><span class="nx">lang</span><span class="o">,</span> <span class="nx">availableLangs</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">bestLang</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">matchingKeys</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">matchingKeys</span><span class="p">[</span><span class="nx">i</span><span class="p">]].</span><span class="nx">lang</span> <span class="o">===</span> <span class="nx">bestLang</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">bestCtxKey</span> <span class="o">=</span> <span class="nx">matchingKeys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">bestCtxKey</span> <span class="o">||</span>
            <span class="p">(</span><span class="nx">matchingKeys</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">matchingKeys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span>
            <span class="kc">null</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// TODO DOCS [bug 4647368]</span>
    <span class="nx">getMojitTypeDetails</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">dest</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">//logger.log(&#39;getMojitTypeDetails(&#39;+env+&#39;,ctx,&#39;+mojitType+&#39;)&#39;);</span>
        <span class="kd">var</span> <span class="nx">ress</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">name</span><span class="o">,</span>
            <span class="nx">engine</span><span class="o">,</span> <span class="nx">engines</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">ctxKey</span><span class="o">,</span>
            <span class="nx">assumeRollups</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">assumeRollups</span><span class="o">,</span>
            <span class="nx">module</span><span class="o">;</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">dest</span><span class="p">){</span>
            <span class="nx">dest</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">actions</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dest</span><span class="p">.</span><span class="nx">actions</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">assets</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dest</span><span class="p">.</span><span class="nx">assets</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">models</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dest</span><span class="p">.</span><span class="nx">models</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">modelYUIModuleNames</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dest</span><span class="p">.</span><span class="nx">modelYUIModuleNames</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span> <span class="o">=</span> <span class="p">{</span><span class="nx">config</span><span class="o">:</span> <span class="p">{}</span><span class="o">,</span> <span class="nx">requires</span><span class="o">:</span> <span class="p">[]};</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="p">{</span><span class="nx">modules</span><span class="o">:</span> <span class="p">{}};</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">modules</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">modules</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">requires</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">requires</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;precomputed&#39;</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">dependencyCalculations</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">ctxKey</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_findBestContext</span><span class="p">(</span><span class="nx">ctx</span><span class="o">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">);</span>
            <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">requires</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiRequired</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">];</span>
            <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">sorted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">];</span>
            <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">sortedPaths</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSortedPaths</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nx">dest</span><span class="p">.</span><span class="nx">assetsRoot</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitAssetRoots</span><span class="p">[</span><span class="nx">mojitType</span><span class="p">];</span>
        <span class="nx">dest</span><span class="p">.</span><span class="nx">definition</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getMojitConfig</span><span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="s1">&#39;definition&#39;</span><span class="p">);</span>
        <span class="nx">dest</span><span class="p">.</span><span class="nx">defaults</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getMojitConfig</span><span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="s1">&#39;defaults&#39;</span><span class="p">);</span>

        <span class="nx">ress</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getResourceListForContext</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">]</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="nx">ress</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">ress</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>

                <span class="c">//console.log(&#39;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; &#39; + res.type +&#39;:&#39;+res.yuiModuleName);</span>
                <span class="c">//console.log(res);</span>

                <span class="nx">res</span> <span class="o">=</span> <span class="nx">ress</span><span class="p">[</span><span class="nx">resid</span><span class="p">];</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;action&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">env</span> <span class="o">===</span> <span class="s1">&#39;client&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">assumeRollups</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">dest</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">rollupURL</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">dest</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;asset&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">name</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">assetType</span><span class="o">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">env</span> <span class="o">===</span> <span class="s1">&#39;client&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">assumeRollups</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">dest</span><span class="p">.</span><span class="nx">assets</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rollupURL</span><span class="o">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">dest</span><span class="p">.</span><span class="nx">assets</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span><span class="o">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">assets</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;binder&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                    <span class="p">}</span>
                    <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="s1">&#39;binder-url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span><span class="o">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">env</span> <span class="o">===</span> <span class="s1">&#39;client&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">assumeRollups</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="s1">&#39;binder-path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rollupURL</span><span class="o">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="s1">&#39;binder-path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span><span class="o">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="s1">&#39;binder-path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">;</span>
                    <span class="p">}</span>
                    <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="s1">&#39;binder-module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="o">;</span>
                    <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="s1">&#39;binder-yui-sorted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiSortedPaths</span><span class="o">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;server&#39;</span> <span class="o">===</span> <span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c">// don&#39;t do any other type of server-side processing for the binder</span>
                        <span class="c">// ESPECIALLY don&#39;t add it to dest.yui.*</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;controller&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c">// We need the YUI Module name of the contoller so we can select a language for it</span>
                    <span class="nx">dest</span><span class="p">.</span><span class="nx">controllerModuleName</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="o">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">env</span> <span class="o">===</span> <span class="s1">&#39;client&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">assumeRollups</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">dest</span><span class="p">.</span><span class="nx">controller</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rollupURL</span><span class="o">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">dest</span><span class="p">.</span><span class="nx">controller</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span><span class="o">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">controller</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="c">// TODO:  why is this commented-out but not deleted?</span>
                <span class="c">//if (res.type === &#39;yui-lang&#39;) {</span>
                <span class="c">//    dest.lang = (&#39;client&#39; === env) ? res.staticHandlerURL : res.fsPath;</span>
                <span class="c">//}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;model&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">env</span> <span class="o">===</span> <span class="s1">&#39;client&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">assumeRollups</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">dest</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rollupURL</span><span class="o">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">dest</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span><span class="o">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">modelYUIModuleNames</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="c">//                        logger.log(&quot;Processing Models:&quot; + res.name  + &quot;:&quot; + res.yuiModuleName, &#39;mojito&#39;, NAME);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;view&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">env</span> <span class="o">===</span> <span class="s1">&#39;client&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">assumeRollups</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="s1">&#39;content-path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rollupURL</span><span class="o">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="s1">&#39;content-path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span><span class="o">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="s1">&#39;content-path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">;</span>
                    <span class="p">}</span>
                    <span class="nx">dest</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">engine</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">viewEngine</span><span class="o">;</span>
                    <span class="nx">engines</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">viewEngine</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">addonType</span> <span class="o">===</span> <span class="s1">&#39;view-engines&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c">// we&#39;ll only load the viewEngines that we need</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;fw&#39;</span> <span class="o">===</span> <span class="nx">res</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="s1">&#39;app&#39;</span> <span class="o">===</span> <span class="nx">res</span><span class="p">.</span><span class="nx">source</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="p">}</span>
                    <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="nx">fullpath</span><span class="o">:</span> <span class="kc">undefined</span><span class="o">,</span>
                        <span class="nx">requires</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleMeta</span><span class="p">.</span><span class="nx">requires</span> <span class="o">||</span> <span class="p">[]</span>
                    <span class="p">};</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">env</span> <span class="o">===</span> <span class="s1">&#39;client&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">assumeRollups</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">].</span><span class="nx">fullpath</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rollupURL</span><span class="o">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">].</span><span class="nx">fullpath</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span><span class="o">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">].</span><span class="nx">fullpath</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">;</span>
                    <span class="p">}</span>

                    <span class="c">// If we have &quot;lang&quot; use it</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitLangs</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">])</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">_mojitLangs</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">].</span><span class="nx">sort</span><span class="p">();</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">].</span><span class="nx">lang</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitLangs</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">];</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">engine</span> <span class="k">in</span> <span class="nx">engines</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">engines</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">engine</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">resid</span> <span class="o">=</span> <span class="s1">&#39;addon-view-engines-&#39;</span> <span class="o">+</span> <span class="nx">engine</span><span class="o">;</span>
                <span class="nx">res</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getContextualizedResource</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">]</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">resid</span><span class="p">);</span>
                <span class="nx">dest</span><span class="p">.</span><span class="nx">yui</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="nx">fullpath</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;client&#39;</span> <span class="o">===</span> <span class="nx">env</span><span class="p">)</span> <span class="o">?</span> <span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span> <span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">,</span>
                    <span class="nx">requires</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleMeta</span><span class="p">.</span><span class="nx">requires</span> <span class="o">||</span> <span class="p">[]</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">dest</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// TODO DOCS [bug 4647383]</span>
    <span class="nx">getRollupsApp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">dest</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_root</span><span class="o">,</span> <span class="s1">&#39;rollup.&#39;</span><span class="o">+</span><span class="nx">env</span><span class="o">+</span><span class="s1">&#39;.js&#39;</span><span class="p">)</span><span class="o">,</span>
            <span class="nx">srcs</span> <span class="o">=</span> <span class="p">[]</span><span class="o">,</span>
            <span class="nx">ress</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">;</span>
        <span class="nx">ress</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getResourceListForContext</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_fwMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">]</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="nx">ress</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">ress</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">res</span> <span class="o">=</span> <span class="nx">ress</span><span class="p">[</span><span class="nx">resid</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="p">}</span>
                <span class="nx">srcs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">ress</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getResourceListForContext</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">]</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="nx">ress</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">ress</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">res</span> <span class="o">=</span> <span class="nx">ress</span><span class="p">[</span><span class="nx">resid</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="p">}</span>
                    <span class="nx">srcs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="nx">dest</span><span class="o">:</span> <span class="nx">dest</span><span class="o">,</span>
            <span class="nx">srcs</span><span class="o">:</span> <span class="nx">srcs</span>
        <span class="p">};</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// TODO DOCS [bug 4647385]</span>
    <span class="c">// This example comes from GSG5.</span>
    <span class="c">// { FlickrDetail:</span>
    <span class="c">//      dest: &#39;/blah/blah/mojits/FlickrDetail/rollup.client.js&#39;</span>
    <span class="c">//      srcs: [</span>
    <span class="c">//          &#39;/blah/blah/mojits/FlickrDetail/controller.common.js&#39;,</span>
    <span class="c">//          &#39;/blah/blah/mojits/FlickrDetail/binders/index.js&#39;,</span>
    <span class="c">//          &#39;/blah/blah/mojits/FlickrDetail/lang/FlickrDetail_de.js&#39;,</span>
    <span class="c">//          &#39;/blah/blah/mojits/FlickrDetail/lang/FlickrDetail_en-US.js&#39;</span>
    <span class="c">//      ]</span>
    <span class="c">// }</span>
    <span class="nx">getRollupsMojits</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">mojitName</span><span class="o">,</span> <span class="nx">ress</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span>
            <span class="nx">dest</span><span class="o">,</span> <span class="nx">srcs</span><span class="o">,</span> <span class="nx">rollups</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">mojitoMojits</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">mojitoRoot</span><span class="o">,</span> <span class="s1">&#39;mojits&#39;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">mojitName</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">mojitName</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">srcs</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="nx">ress</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getResourceListForContext</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitName</span><span class="p">]</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="nx">ress</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">ress</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">res</span> <span class="o">=</span> <span class="nx">ress</span><span class="p">[</span><span class="nx">resid</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">source</span> <span class="o">!==</span> <span class="s1">&#39;mojit&#39;</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">continue</span><span class="o">;</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">continue</span><span class="o">;</span>
                        <span class="p">}</span>
                        <span class="nx">srcs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="nx">dest</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitPaths</span><span class="p">[</span><span class="nx">mojitName</span><span class="p">]</span><span class="o">,</span> <span class="s1">&#39;rollup.&#39;</span><span class="o">+</span><span class="nx">env</span><span class="o">+</span><span class="s1">&#39;.js&#39;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">dest</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">mojitoMojits</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c">// we shouldn&#39;t write to the mojits that ship with Mojito</span>
                    <span class="nx">dest</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">dest</span> <span class="o">&amp;&amp;</span> <span class="nx">srcs</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">rollups</span><span class="p">[</span><span class="nx">mojitName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="nx">dest</span><span class="o">:</span> <span class="nx">dest</span><span class="o">,</span>
                        <span class="nx">srcs</span><span class="o">:</span> <span class="nx">srcs</span>
                    <span class="p">};</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">rollups</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// TODO DOCS 2011-07-21</span>
    <span class="c">// This example comes from (a modified) GSG5.</span>
    <span class="c">// [ {</span>
    <span class="c">//      context: { device: &#39;iphone&#39; },</span>
    <span class="c">//      mojitName: &#39;FlickrDetail&#39;,</span>
    <span class="c">//      yuiModuleName: &#39;inlinecss/FlickrDetail&#39;,</span>
    <span class="c">//      dest: &#39;/blah/blah/mojits/FlickrDetail/autoload/compiled/css.iphone.client.js&#39;,</span>
    <span class="c">//      srcs: {</span>
    <span class="c">//          &#39;/static/FlickrDetail/assets/index.css&#39;:  &#39;/blah/blah/blah/mojits/FlickrDetail/assets/index.iphone.css&#39;,</span>
    <span class="c">//          &#39;/static/FlickrDetail/assets/message.css&#39;:  &#39;/blah/blah/blah/mojits/FlickrDetail/assets/message.css&#39;</span>
    <span class="c">//   }</span>
    <span class="c">// ]</span>
    <span class="nx">getInlineCssMojits</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">ctxFilter</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">mojitName</span><span class="o">,</span> <span class="nx">ctxKey</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">ress</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">selector</span><span class="o">,</span>
            <span class="nx">dest</span><span class="o">,</span> <span class="nx">srcs</span><span class="o">,</span> <span class="nx">inlines</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="nx">mojitoMojits</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">mojitoRoot</span><span class="o">,</span> <span class="s1">&#39;mojits&#39;</span><span class="p">);</span>

        <span class="c">// This will make our test later a little easier.</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">ctxFilter</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">ctxFilter</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">ctxFilter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">mojitName</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">mojitName</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">ctxKey</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitName</span><span class="p">].</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitName</span><span class="p">].</span><span class="nx">contexts</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">ctxKey</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitName</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">ctxFilter</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_matchContext</span><span class="p">(</span><span class="nx">ctx</span><span class="o">,</span> <span class="nx">ctxFilter</span><span class="p">))</span> <span class="p">{</span>
                            <span class="k">continue</span><span class="o">;</span>
                        <span class="p">}</span>

                        <span class="nx">ress</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cloneObj</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitName</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="o">!==</span> <span class="nx">ctxKey</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">ress</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mergeRecursive</span><span class="p">(</span><span class="nx">ress</span><span class="o">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitName</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">]);</span>
                        <span class="p">}</span>
                        <span class="nx">srcs</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="nx">ress</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">ress</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                                <span class="nx">res</span> <span class="o">=</span> <span class="nx">ress</span><span class="p">[</span><span class="nx">resid</span><span class="p">];</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">source</span> <span class="o">!==</span> <span class="s1">&#39;mojit&#39;</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="k">continue</span><span class="o">;</span>
                                <span class="p">}</span>
                                <span class="k">if</span> <span class="p">((</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;asset&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">assetType</span> <span class="o">!==</span> <span class="s1">&#39;css&#39;</span><span class="p">))</span> <span class="p">{</span>
                                    <span class="k">continue</span><span class="o">;</span>
                                <span class="p">}</span>
                                <span class="nx">srcs</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="nx">selector</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_selectorFromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span>
                        <span class="nx">dest</span> <span class="o">=</span> <span class="s1">&#39;autoload/compiled/inlinecss&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">selector</span> <span class="o">?</span> <span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nx">selector</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.common.js&#39;</span><span class="o">;</span>
                        <span class="nx">dest</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitPaths</span><span class="p">[</span><span class="nx">mojitName</span><span class="p">]</span><span class="o">,</span> <span class="nx">dest</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">dest</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">mojitoMojits</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="c">// we shouldn&#39;t write to the mojits that ship with Mojito</span>
                            <span class="k">continue</span><span class="o">;</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">srcs</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">inlines</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                                <span class="nx">context</span><span class="o">:</span> <span class="nx">ctx</span><span class="o">,</span>
                                <span class="nx">mojitName</span><span class="o">:</span> <span class="nx">mojitName</span><span class="o">,</span>
                                <span class="nx">yuiModuleName</span><span class="o">:</span> <span class="s1">&#39;inlinecss/&#39;</span> <span class="o">+</span> <span class="nx">mojitName</span><span class="o">,</span>
                                <span class="nx">dest</span><span class="o">:</span> <span class="nx">dest</span><span class="o">,</span>
                                <span class="nx">srcs</span><span class="o">:</span> <span class="nx">srcs</span>
                            <span class="p">});</span>
                        <span class="p">}</span>

                    <span class="p">}</span> <span class="c">// has</span>
                <span class="p">}</span> <span class="c">// foreach ctxKey</span>
            <span class="p">}</span> <span class="c">// has</span>
        <span class="p">}</span> <span class="c">// foreach mojit</span>
        <span class="k">return</span> <span class="nx">inlines</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// ===========================================</span>
    <span class="c">// ================= PRIVATE =================</span>

    <span class="nx">_readAppConfigNC</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_root</span><span class="o">,</span> <span class="s1">&#39;application.json&#39;</span><span class="p">)</span><span class="o">,</span>
            <span class="nx">config</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cloneObj</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_fwConfig</span><span class="p">.</span><span class="nx">appConfigBase</span><span class="p">)</span><span class="o">,</span>
            <span class="nx">appConfig</span><span class="o">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">path</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">appConfig</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_readConfigYCB</span><span class="p">({}</span><span class="o">,</span> <span class="nx">path</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_mergeRecursive</span><span class="p">(</span><span class="nx">config</span><span class="o">,</span> <span class="nx">appConfig</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">config</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// TODO DREW 2011-06-16: [bug 4647391] work out story for this stage</span>
    <span class="nx">_preloadMeta</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="o">,</span> <span class="nx">path</span><span class="o">,</span> <span class="nx">realDirs</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDirMojit</span><span class="p">(</span><span class="s1">&#39;fw&#39;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">mojitoRoot</span><span class="o">,</span><span class="s1">&#39;app&#39;</span><span class="p">));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDirMojits</span><span class="p">(</span><span class="kc">false</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">mojitoRoot</span><span class="o">,</span><span class="s1">&#39;mojits&#39;</span><span class="p">));</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadFileConfig</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">appMeta</span><span class="o">,</span> <span class="s1">&#39;app&#39;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_root</span><span class="o">,</span><span class="s1">&#39;application.json&#39;</span><span class="p">)</span><span class="o">,</span> <span class="s1">&#39;definition&#39;</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDirMojit</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_root</span><span class="p">);</span>

        <span class="c">// TODO DREW 2011-06-16: [bug 4647391] split loops into separate functions (for readability)</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">routesFiles</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">routesFiles</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">!==</span> <span class="nx">path</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_root</span><span class="o">,</span> <span class="nx">path</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_preloadFileConfig</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">appMeta</span><span class="o">,</span> <span class="s1">&#39;app&#39;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="nx">path</span><span class="o">,</span> <span class="s1">&#39;routes&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">mojitsDirs</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">mojitsDirs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">!==</span> <span class="nx">path</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_root</span><span class="o">,</span> <span class="nx">path</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">libglob</span><span class="p">.</span><span class="nx">globSync</span><span class="p">(</span><span class="nx">path</span><span class="o">,</span> <span class="p">{}</span><span class="o">,</span> <span class="nx">realDirs</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">realDirs</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Failed to find any mojitsDirs matching &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">mojitsDirs</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">realDirs</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">path</span> <span class="o">=</span> <span class="nx">realDirs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDirMojits</span><span class="p">(</span><span class="kc">true</span><span class="o">,</span> <span class="nx">path</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">mojitDirs</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">mojitDirs</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">realDirs</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">mojitDirs</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">mojitDirs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">!==</span> <span class="nx">path</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_root</span><span class="o">,</span> <span class="nx">path</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">libglob</span><span class="p">.</span><span class="nx">globSync</span><span class="p">(</span><span class="nx">path</span><span class="o">,</span> <span class="p">{}</span><span class="o">,</span> <span class="nx">realDirs</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">realDirs</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Failed to find any mojitDirs matching &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">mojitDirs</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">realDirs</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">path</span> <span class="o">=</span> <span class="nx">realDirs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDirMojit</span><span class="p">(</span><span class="s1">&#39;mojit&#39;</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">path</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_preloadDirMojits</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">readConfig</span><span class="o">,</span> <span class="nx">fullpath</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="c">//logger.log(&#39;----------------------- preloadDirMojits(&#39; + readConfig + &#39;) -- &#39; + fullpath);</span>
        <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">)</span><span class="o">,</span>
            <span class="nx">i</span><span class="o">,</span> <span class="nx">childName</span><span class="o">,</span> <span class="nx">childPath</span><span class="o">,</span> <span class="nx">mojitName</span><span class="o">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">childName</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">===</span> <span class="nx">childName</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="p">}</span>
            <span class="nx">childPath</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="nx">childName</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDirMojit</span><span class="p">(</span><span class="s1">&#39;mojit&#39;</span><span class="o">,</span> <span class="nx">readConfig</span><span class="o">,</span> <span class="nx">childPath</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_preloadDirMojit</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="o">,</span> <span class="nx">readConfig</span><span class="o">,</span> <span class="nx">fullpath</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
<span class="c">//        logger.log(&#39;----------------------- preloadDirMojit(&#39; + source + &#39;,&#39; + readConfig + &#39;) -- &#39; + fullpath);</span>
        <span class="kd">var</span> <span class="nx">packageJson</span><span class="o">,</span> <span class="nx">definitionJson</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">dest</span><span class="o">,</span>
            <span class="nx">appConfig</span><span class="o">,</span> <span class="nx">urlPrefix</span><span class="o">,</span> <span class="nx">url</span><span class="o">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">readConfig</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;mojit&#39;</span> <span class="o">===</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">packageJson</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_readMojitConfigFile</span><span class="p">(</span><span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;package.json&#39;</span><span class="p">)</span><span class="o">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="nx">mojitType</span> <span class="o">=</span> <span class="nx">packageJson</span><span class="p">.</span><span class="nx">name</span><span class="o">;</span>

            <span class="nx">definitionJson</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_readMojitConfigFile</span><span class="p">(</span><span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;definition.json&#39;</span><span class="p">)</span><span class="o">,</span> <span class="kc">true</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">definitionJson</span><span class="p">.</span><span class="nx">appLevel</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">source</span> <span class="o">=</span> <span class="s1">&#39;app&#39;</span><span class="o">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">mojitType</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">mojitType</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_mojitPaths</span><span class="p">[</span><span class="nx">mojitType</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="o">;</span>

        <span class="nx">switch</span> <span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">case</span> <span class="s1">&#39;fw&#39;</span><span class="o">:</span>
                <span class="nx">dest</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">fwMeta</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="nx">case</span> <span class="s1">&#39;app&#39;</span><span class="o">:</span>
                <span class="nx">dest</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">appMeta</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="nx">case</span> <span class="s1">&#39;mojit&#39;</span><span class="o">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">mojitMeta</span><span class="p">[</span><span class="nx">mojitType</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">mojitMeta</span><span class="p">[</span><span class="nx">mojitType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="p">}</span>
                <span class="nx">dest</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">mojitMeta</span><span class="p">[</span><span class="nx">mojitType</span><span class="p">];</span>
                <span class="k">break</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="c">// TODO DREW 2011-06-16: [bug 4647391] refactor to return semantics</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">readConfig</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;fw&#39;</span> <span class="o">!==</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitoVersionMatch</span><span class="p">(</span><span class="nx">packageJson</span><span class="o">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_version</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Mojito version mismatch: mojit skipped in &quot;&#39;</span> <span class="o">+</span> <span class="nx">fullpath</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">,</span> <span class="s1">&#39;warn&#39;</span><span class="o">,</span> <span class="nx">NAME</span><span class="p">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_mojitPackageAsAsset</span><span class="p">(</span><span class="nx">packageJson</span><span class="o">,</span> <span class="nx">fullpath</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;mojit&#39;</span> <span class="o">===</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
            <span class="c">// TODO DREW 2011-06-16: [bug 4647391] make this more future-proof</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_preloadFileController</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;controller.common.js&#39;</span><span class="p">)</span><span class="o">,</span> <span class="nx">fullpath</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_preloadFileController</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;controller.client.js&#39;</span><span class="p">)</span><span class="o">,</span> <span class="nx">fullpath</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_preloadFileController</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;controller.server.js&#39;</span><span class="p">)</span><span class="o">,</span> <span class="nx">fullpath</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">readConfig</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_preloadFileConfig</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;definition.json&#39;</span><span class="p">)</span><span class="o">,</span> <span class="s1">&#39;definition&#39;</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_preloadFileConfig</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;defaults.json&#39;</span><span class="p">)</span><span class="o">,</span> <span class="s1">&#39;defaults&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c">// TODO DREW 2011-06-16: [bug 4647391] pass actual functions (instead of function names)</span>
        <span class="c">// TODO DREW 2011-06-16: [bug 4647391] refactor:  first, use a method that returns all files in dir (with ext), then call _preloadFileX on them</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDir</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;actions&#39;</span><span class="p">)</span><span class="o">,</span>  <span class="kc">false</span><span class="o">,</span> <span class="s1">&#39;_preloadFileAction&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDir</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;addons&#39;</span><span class="p">)</span><span class="o">,</span>   <span class="kc">true</span><span class="o">,</span>  <span class="s1">&#39;_preloadFileAddon&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDir</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span><span class="o">,</span>   <span class="kc">true</span><span class="o">,</span>  <span class="s1">&#39;_preloadFileAsset&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDir</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;autoload&#39;</span><span class="p">)</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>  <span class="s1">&#39;_preloadFileAutoload&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDir</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;binders&#39;</span><span class="p">)</span><span class="o">,</span>  <span class="kc">true</span><span class="o">,</span>  <span class="s1">&#39;_preloadFileBinder&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDir</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span><span class="o">,</span>     <span class="kc">false</span><span class="o">,</span> <span class="s1">&#39;_preloadFileLang&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDir</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;models&#39;</span><span class="p">)</span><span class="o">,</span>   <span class="kc">false</span><span class="o">,</span> <span class="s1">&#39;_preloadFileModel&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDir</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;views&#39;</span><span class="p">)</span><span class="o">,</span>    <span class="kc">true</span><span class="o">,</span>  <span class="s1">&#39;_preloadFileView&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDir</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;specs&#39;</span><span class="p">)</span><span class="o">,</span>    <span class="kc">false</span><span class="o">,</span> <span class="s1">&#39;_preloadFileSpec&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDir</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;tests&#39;</span><span class="p">)</span><span class="o">,</span>    <span class="kc">false</span><span class="o">,</span> <span class="s1">&#39;_preloadFileAutoload&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDir</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;tests/models&#39;</span><span class="p">)</span><span class="o">,</span>    <span class="kc">false</span><span class="o">,</span> <span class="s1">&#39;_preloadFileAutoload&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDir</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span><span class="s1">&#39;tests/binders&#39;</span><span class="p">)</span><span class="o">,</span>    <span class="kc">false</span><span class="o">,</span> <span class="s1">&#39;_preloadFileAutoload&#39;</span><span class="p">);</span>

        <span class="c">/*</span>
<span class="c">         * Here we are making a URL for the expanded &quot;definition.json&quot;</span>
<span class="c">         * The URL we make does not map to a real file, it is used by the tunnel</span>
<span class="c">         * to ID the and expand the actual &quot;definition.json&quot;.</span>
<span class="c">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;mojit&#39;</span> <span class="o">===</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>

            <span class="c">// TODO 2011-06-16: [bug 4647391] re-use logic from _calcStaticHandlerURL() for prefix (so that all options are supported)</span>

            <span class="nx">appConfig</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">staticHandling</span> <span class="o">||</span> <span class="p">{};</span>
            <span class="nx">urlPrefix</span> <span class="o">=</span> <span class="s1">&#39;/static&#39;</span><span class="o">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">appConfig</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">urlPrefix</span> <span class="o">=</span> <span class="nx">appConfig</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">?</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nx">appConfig</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="o">;</span>
            <span class="p">}</span>

            <span class="c">// Add our definition to the Dynamic URLs list</span>
            <span class="nx">url</span> <span class="o">=</span> <span class="nx">urlPrefix</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">mojitType</span> <span class="o">+</span> <span class="s1">&#39;/definition.json&#39;</span><span class="o">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_dynamicURLs</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="s1">&#39;definition.json&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_preloadDir</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">fullpath</span><span class="o">,</span> <span class="nx">recurse</span><span class="o">,</span> <span class="nx">fileHandler</span><span class="o">,</span> <span class="nx">root</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="c">//logger.log(&#39;----------------------- preloadDir(&#39; + recurse + &#39;,&#39; + fileHandler + &#39;) -- &#39; + fullpath);</span>
        <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">)</span><span class="o">,</span>
            <span class="nx">i</span><span class="o">,</span> <span class="nx">childName</span><span class="o">,</span> <span class="nx">childPath</span><span class="o">,</span> <span class="nx">childStat</span><span class="o">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">root</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">root</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">childName</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">===</span> <span class="nx">childName</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="p">}</span>
            <span class="nx">childPath</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="nx">childName</span><span class="p">);</span>
            <span class="nx">childStat</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">childPath</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">childStat</span><span class="p">.</span><span class="nx">isFile</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">[</span><span class="nx">fileHandler</span><span class="p">](</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">childPath</span><span class="o">,</span> <span class="nx">root</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">recurse</span> <span class="o">&amp;&amp;</span> <span class="nx">childStat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">_preloadDir</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">childPath</span><span class="o">,</span> <span class="nx">recurse</span><span class="o">,</span> <span class="nx">fileHandler</span><span class="o">,</span> <span class="nx">root</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_preloadFileAction</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">fullpath</span><span class="o">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;.js&#39;</span> <span class="o">!==</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="c">//logger.log(&#39;----------------------- preloadFileActions -- &#39; + fullpath);</span>
        <span class="kd">var</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">pathParts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parsePath</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="s1">&#39;server&#39;</span><span class="o">,</span> <span class="nx">dir</span><span class="p">);</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;action&#39;</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">name</span><span class="o">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcYuiModule</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcStaticURL</span><span class="p">(</span><span class="nx">res</span><span class="o">,</span> <span class="nx">mojitType</span><span class="p">);</span>
        <span class="nx">resid</span> <span class="o">=</span> <span class="s1">&#39;action-&#39;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="o">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadSetDest</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">pathParts</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_preloadFileAddon</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">fullpath</span><span class="o">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;.js&#39;</span> <span class="o">!==</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="c">//logger.log(&#39;----------------------- preloadFileAddon -- &#39; + fullpath);</span>
        <span class="kd">var</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">pathParts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parsePath</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="s1">&#39;server&#39;</span><span class="o">,</span> <span class="nx">dir</span><span class="p">);</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;addon&#39;</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">addonType</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">pathParts</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">pathParts</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcYuiModule</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcStaticURL</span><span class="p">(</span><span class="nx">res</span><span class="o">,</span> <span class="nx">mojitType</span><span class="p">);</span>
        <span class="nx">resid</span> <span class="o">=</span> <span class="s1">&#39;addon-&#39;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">addonType</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="o">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadSetDest</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">pathParts</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_preloadFileAsset</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">fullpath</span><span class="o">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="c">//logger.log(&#39;----------------------- preloadFileAsset -- &#39; + fullpath);</span>
        <span class="kd">var</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">pathParts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parsePath</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="s1">&#39;common&#39;</span><span class="o">,</span> <span class="nx">dir</span><span class="p">);</span>
        <span class="c">// All assets are &quot;common&quot;, and we want to support the</span>
        <span class="c">// shortcut of &quot;assets/foo.iphone.css&quot;.</span>
        <span class="nx">pathParts</span><span class="p">.</span><span class="nx">affinity</span> <span class="o">=</span> <span class="s1">&#39;common&#39;</span><span class="o">;</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;asset&#39;</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">assetType</span> <span class="o">=</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">name</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">relpath</span> <span class="o">=</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">relpath</span><span class="o">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcStaticURL</span><span class="p">(</span><span class="nx">res</span><span class="o">,</span> <span class="nx">mojitType</span><span class="p">);</span>
        <span class="nx">resid</span> <span class="o">=</span> <span class="s1">&#39;asset-&#39;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">assetType</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="o">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadSetDest</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">pathParts</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// This function process all subdirectories using the same logic, so that all files within</span>
    <span class="c">// an &quot;autoload&quot; directory will be processed.</span>
    <span class="nx">_preloadFileAutoload</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">fullpath</span><span class="o">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;.js&#39;</span> <span class="o">!==</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
<span class="c">//        logger.log(&#39;----------------------- preloadFileAutoload -- &#39; + fullpath);</span>
        <span class="kd">var</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">pathParts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parsePath</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="s1">&#39;server&#39;</span><span class="o">,</span> <span class="nx">dir</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pathParts</span><span class="p">.</span><span class="nx">affinity</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="c">// This allows the app config to specify that some &quot;client&quot; affinity code should not be deployed</span>
            <span class="c">// if it has an &quot;optional&quot; subtype</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">deferAllOptionalAutoloads</span> <span class="o">&amp;&amp;</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">affinity</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;optional&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">pathParts</span><span class="p">.</span><span class="nx">affinity</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="o">;</span>
            <span class="p">}</span>
            <span class="c">// this filters tests from being included with deployed applications</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pathParts</span><span class="p">.</span><span class="nx">affinity</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;tests&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">env</span> <span class="o">!==</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">pathParts</span><span class="p">.</span><span class="nx">affinity</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="o">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;none&#39;</span> <span class="o">===</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">affinity</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;yui-module&#39;</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="o">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcYuiModule</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;.js&#39;</span> <span class="o">===</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">ext</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Expected YUI3 module in &quot;</span> <span class="o">+</span> <span class="nx">fullpath</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcStaticURL</span><span class="p">(</span><span class="nx">res</span><span class="o">,</span> <span class="nx">mojitType</span><span class="p">);</span>
        <span class="nx">resid</span> <span class="o">=</span> <span class="s1">&#39;yui-module-&#39;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="o">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadSetDest</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">pathParts</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="nx">_preloadFileBinder</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">fullpath</span><span class="o">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;.js&#39;</span> <span class="o">!==</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="c">//logger.log(&#39;----------------------- preloadFileBinder -- &#39; + fullpath);</span>
        <span class="kd">var</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">pathParts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parsePath</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="s1">&#39;client&#39;</span><span class="o">,</span> <span class="nx">dir</span><span class="p">);</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;binder&#39;</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">name</span><span class="o">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcYuiModule</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcStaticURL</span><span class="p">(</span><span class="nx">res</span><span class="o">,</span> <span class="nx">mojitType</span><span class="p">);</span>
        <span class="nx">resid</span> <span class="o">=</span> <span class="s1">&#39;binder-&#39;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">name</span><span class="o">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadSetDest</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">pathParts</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_preloadFileConfig</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">fullpath</span><span class="o">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="c">//logger.log(&#39;----------------------- preloadFileConfig(&#39; + type + &#39;) -- &#39; + fullpath);</span>
        <span class="kd">var</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">pathParts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parsePath</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="s1">&#39;server&#39;</span><span class="o">,</span> <span class="kc">null</span><span class="p">);</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;config&#39;</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">configType</span> <span class="o">=</span> <span class="nx">type</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="o">;</span>
        <span class="nx">resid</span> <span class="o">=</span> <span class="s1">&#39;config-&#39;</span> <span class="o">+</span> <span class="nx">type</span><span class="o">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;routes&#39;</span> <span class="o">===</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">resid</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">name</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadSetDest</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">pathParts</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_preloadFileController</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">fullpath</span><span class="o">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;.js&#39;</span> <span class="o">!==</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="c">//logger.log(&#39;----------------------- preloadFileController -- &#39; + fullpath);</span>
        <span class="kd">var</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">pathParts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parsePath</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="s1">&#39;server&#39;</span><span class="o">,</span> <span class="nx">dir</span><span class="p">);</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;controller&#39;</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="o">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcYuiModule</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcStaticURL</span><span class="p">(</span><span class="nx">res</span><span class="o">,</span> <span class="nx">mojitType</span><span class="p">);</span>
        <span class="nx">resid</span> <span class="o">=</span> <span class="s1">&#39;controller&#39;</span><span class="o">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadSetDest</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">pathParts</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_preloadFileLang</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">fullpath</span><span class="o">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;.js&#39;</span> <span class="o">!==</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="c">//logger.log(&#39;----------------------- preloadFileLang -- &#39; + fullpath);</span>
        <span class="kd">var</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">pathParts</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">matches</span><span class="o">,</span> <span class="nx">code</span><span class="o">;</span>

        <span class="c">// YUI-intl doesn&#39;t support our &quot;.affinity.&quot; filename syntax.</span>
        <span class="nx">pathParts</span><span class="p">.</span><span class="nx">ext</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">);</span>
        <span class="nx">pathParts</span><span class="p">.</span><span class="nx">shortpath</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">ext</span><span class="p">);</span>

        <span class="c">// There is not a &quot;lang&quot; for the default language file</span>
        <span class="nx">matches</span> <span class="o">=</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">shortpath</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^([^_]+)(?:_([^_.]+))?$/</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>

        <span class="c">// TODO: [bug 4647407] Check this as we could have names with underscores</span>
        <span class="c">// YUI-intl expects default language to have no code on the filename.</span>
        <span class="c">// (In practice it&#39;s &#39;en&#39;, but don&#39;t assume that here.)</span>
        <span class="nx">code</span> <span class="o">=</span> <span class="nx">matches</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="o">;</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;yui-lang&#39;</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="o">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcYuiModule</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcStaticURL</span><span class="p">(</span><span class="nx">res</span><span class="o">,</span> <span class="nx">mojitType</span><span class="p">);</span>
        <span class="nx">resid</span> <span class="o">=</span> <span class="s1">&#39;yui-lang-&#39;</span> <span class="o">+</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">shortpath</span><span class="o">;</span>

        <span class="c">// Check the mojitType has a &quot;lang&quot; entry</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitLangs</span><span class="p">[</span><span class="nx">mojitType</span><span class="p">]){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_mojitLangs</span><span class="p">[</span><span class="nx">mojitType</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="p">}</span>

        <span class="c">// If we have a &quot;lang&quot; code add it to the list</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">code</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_mojitLangs</span><span class="p">[</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="nx">pathParts</span><span class="p">.</span><span class="nx">affinity</span> <span class="o">=</span> <span class="s1">&#39;common&#39;</span><span class="o">;</span>
        <span class="nx">pathParts</span><span class="p">.</span><span class="nx">contextKey</span> <span class="o">=</span> <span class="s1">&#39;lang=&#39;</span> <span class="o">+</span> <span class="nx">code</span><span class="o">;</span>
        <span class="nx">pathParts</span><span class="p">.</span><span class="nx">contextParts</span> <span class="o">=</span> <span class="p">{</span><span class="nx">lang</span><span class="o">:</span> <span class="nx">code</span><span class="p">};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadSetDest</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">pathParts</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_preloadFileModel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">fullpath</span><span class="o">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;.js&#39;</span> <span class="o">!==</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="c">//logger.log(&#39;----------------------- preloadFileModel -- &#39; + fullpath);</span>
        <span class="kd">var</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">pathParts</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_parsePath</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="s1">&#39;server&#39;</span><span class="o">,</span> <span class="nx">dir</span><span class="p">);</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;model&#39;</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">name</span><span class="o">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcYuiModule</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcStaticURL</span><span class="p">(</span><span class="nx">res</span><span class="o">,</span> <span class="nx">mojitType</span><span class="p">);</span>
        <span class="nx">resid</span> <span class="o">=</span> <span class="s1">&#39;model-&#39;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="o">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadSetDest</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">pathParts</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_preloadFileView</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">fullpath</span><span class="o">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="c">//logger.log(&#39;----------------------- preloadFileView -- &#39; + fullpath);</span>
        <span class="kd">var</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">parts</span><span class="o">,</span> <span class="nx">pathParts</span> <span class="o">=</span> <span class="p">{</span><span class="nx">affinity</span><span class="o">:</span> <span class="s1">&#39;common&#39;</span><span class="o">,</span> <span class="nx">contextKey</span><span class="o">:</span> <span class="s1">&#39;*&#39;</span><span class="o">,</span> <span class="nx">contextParts</span><span class="o">:</span> <span class="p">{}};</span>

        <span class="c">// views don&#39;t support our &quot;.affinity.&quot; filename syntax.</span>
        <span class="nx">pathParts</span><span class="p">.</span><span class="nx">ext</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">);</span>
        <span class="nx">dir</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">dir</span><span class="o">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
        <span class="nx">pathParts</span><span class="p">.</span><span class="nx">relpath</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">dir</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="nx">pathParts</span><span class="p">.</span><span class="nx">shortpath</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">ext</span><span class="p">);</span>
        <span class="nx">parts</span> <span class="o">=</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">shortpath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="nx">pathParts</span><span class="p">.</span><span class="nx">viewEngine</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
        <span class="nx">pathParts</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">libpath</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">pathParts</span><span class="p">.</span><span class="nx">relpath</span><span class="p">)</span><span class="o">,</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">pathParts</span><span class="p">.</span><span class="nx">contextParts</span><span class="p">.</span><span class="nx">device</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
            <span class="nx">pathParts</span><span class="p">.</span><span class="nx">contextKey</span> <span class="o">=</span> <span class="nx">libqs</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">pathParts</span><span class="p">.</span><span class="nx">contextParts</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="c">// Catch if the view has no engine i.e. &quot;index.html&quot; not &quot;index.mu.html&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">pathParts</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">shortpath</span> <span class="o">===</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">viewEngine</span><span class="p">){</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Mojit view not loaded at &quot;&#39;</span><span class="o">+</span><span class="nx">fullpath</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span><span class="o">,</span> <span class="s1">&#39;warn&#39;</span><span class="o">,</span> <span class="nx">NAME</span><span class="p">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;view&#39;</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">source</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">viewEngine</span> <span class="o">=</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">viewEngine</span><span class="o">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">viewOutputFormat</span> <span class="o">=</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">name</span><span class="o">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcStaticURL</span><span class="p">(</span><span class="nx">res</span><span class="o">,</span> <span class="nx">mojitType</span><span class="p">);</span>
        <span class="nx">resid</span> <span class="o">=</span> <span class="s1">&#39;view-&#39;</span> <span class="o">+</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">name</span><span class="o">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_preloadSetDest</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">pathParts</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="c">/*</span>
<span class="c">     * TODO: Ric added this, needs review.</span>
<span class="c">     *</span>
<span class="c">     * Note: this MUST be called before _preloadFileSpec()</span>
<span class="c">     */</span>
    <span class="nx">_urlsForAppSpecs</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

        <span class="kd">var</span> <span class="nx">specs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">specs</span> <span class="o">||</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">appConfig</span><span class="o">,</span> <span class="nx">prefix</span><span class="o">,</span> <span class="nx">id</span><span class="o">,</span> <span class="nx">url</span><span class="o">;</span>

        <span class="nx">appConfig</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">staticHandling</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="nx">prefix</span> <span class="o">=</span> <span class="s1">&#39;/static&#39;</span><span class="o">;</span>

        <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">appConfig</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">){</span>
            <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">appConfig</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">?</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nx">appConfig</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="o">;</span>
        <span class="p">}</span>
        
        <span class="k">for</span><span class="p">(</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">specs</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">specs</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
                <span class="c">// Set the URL of the spec</span>
                <span class="c">// TODO 2011-06-16:  use appconfig.staticHandling.appName</span>
                <span class="nx">url</span> <span class="o">=</span> <span class="nx">prefix</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39;/specs/default.json&#39;</span><span class="o">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">_dynamicURLs</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application.json&#39;</span><span class="o">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="c">/*</span>
<span class="c">     * TODO: Ric added this, needs review.</span>
<span class="c">     */</span>
    <span class="nx">_preloadFileSpec</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">fullpath</span><span class="o">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">name</span><span class="o">,</span> <span class="nx">url</span><span class="o">,</span> <span class="nx">config</span><span class="o">,</span> <span class="nx">appConfig</span><span class="o">,</span> <span class="nx">prefix</span><span class="o">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        
        <span class="nx">appConfig</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">staticHandling</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="nx">prefix</span> <span class="o">=</span> <span class="s1">&#39;/static&#39;</span><span class="o">;</span>

        <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">appConfig</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">){</span>
            <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">appConfig</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">?</span> <span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nx">appConfig</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="c">// Set the URL of the spec</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="nx">prefix</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="nx">mojitType</span><span class="o">+</span><span class="s1">&#39;/specs/&#39;</span><span class="o">+</span><span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">);</span>

        <span class="c">// Set the name to the mojit type (this is for namespacing)</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="nx">mojitType</span><span class="o">;</span>

        <span class="c">// If the filename is not &quot;default&quot; add it to the spec name</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;default.json&#39;</span><span class="p">){</span>
            <span class="nx">name</span><span class="o">+=</span> <span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="o">,-</span><span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">config</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_readConfigYCB</span><span class="p">({}</span><span class="o">,</span> <span class="nx">fullpath</span><span class="p">);</span>

        <span class="c">// Just incase this has not been made</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">specs</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">specs</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>

        <span class="c">// Add our spec to the specs map</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">specs</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">config</span><span class="o">;</span>

        <span class="c">// Add our spec to the Dynamic URLs list</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_dynamicURLs</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_prereadConfigs</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ctxKey</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">resid</span><span class="o">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="o">!</span> <span class="nx">src</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">src</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">ctxKey</span> <span class="k">in</span> <span class="nx">src</span><span class="p">.</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">contexts</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">ctxKey</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="nx">src</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">src</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">res</span> <span class="o">=</span> <span class="nx">src</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">][</span><span class="nx">resid</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;config&#39;</span> <span class="o">===</span> <span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_configCache</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">])</span> <span class="p">{</span>
                            <span class="c">//logger.log(&#39;prereading &#39; + res.fsPath, &#39;info&#39;, NAME);</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_configCache</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_readConfigJSON</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_readConfigJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">//logger.log(&#39;_readConfigJSON(&#39; + fullpath + &#39;)&#39;);</span>
        <span class="kd">var</span> <span class="nx">json</span><span class="o">,</span> <span class="nx">contents</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_reportJavaScriptSyntaxErrors</span><span class="p">(</span><span class="nx">contents</span><span class="o">,</span> <span class="nx">fullpath</span><span class="p">)</span><span class="o">,</span> <span class="s1">&#39;warn&#39;</span><span class="o">,</span> <span class="nx">NAME</span><span class="p">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Error parsing JSON file: &quot;</span> <span class="o">+</span> <span class="nx">fullpath</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">json</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_readConfigYCB</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="o">,</span> <span class="nx">fullpath</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">contents</span><span class="o">,</span>
            <span class="nx">ycb</span><span class="o">;</span>
        <span class="c">//logger.log(&#39;_readConfigYCB(&#39;+fullpath+&#39;)&#39;, &#39;mojito&#39;, NAME);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">fullpath</span><span class="p">)</span> <span class="p">{</span>
            <span class="c">//logger.log(&#39;unknown fullpath&#39;, &#39;mojito&#39;, NAME);</span>
            <span class="k">return</span> <span class="p">{};</span>
        <span class="p">}</span>

        <span class="nx">contents</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_configCache</span><span class="p">[</span><span class="nx">fullpath</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">contents</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_readConfigJSON</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_configCache</span><span class="p">[</span><span class="nx">fullpath</span><span class="p">]</span> <span class="o">=</span> <span class="nx">contents</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="c">// TODO: bug #4942368, cache smarter so that context can be applied</span>
        <span class="nx">ycb</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_ycbCache</span><span class="p">[</span><span class="nx">fullpath</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">ycb</span><span class="p">)</span> <span class="p">{</span>
            <span class="c">// libycb.read() will distructively modify its first argument</span>
            <span class="nx">ycb</span> <span class="o">=</span> <span class="nx">libycb</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_cloneObj</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span><span class="o">,</span> <span class="p">{}</span> <span class="c">/*ctx*/</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_ycbCache</span><span class="p">[</span><span class="nx">fullpath</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ycb</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">ycb</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_readMojitConfigFile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="o">,</span> <span class="nx">ycb</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">//logger.log(&#39;_readMojitConfigFile(&#39; + path + &#39;,&#39; + ycb + &#39;)&#39;);</span>
        <span class="kd">var</span> <span class="nx">json</span><span class="o">,</span> <span class="nx">contents</span><span class="o">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">path</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ycb</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_readConfigYCB</span><span class="p">({}</span><span class="o">,</span> <span class="nx">path</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">contents</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">path</span><span class="o">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>
            <span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_reportJavaScriptSyntaxErrors</span><span class="p">(</span><span class="nx">contents</span><span class="o">,</span> <span class="nx">path</span><span class="p">)</span><span class="o">,</span> <span class="s1">&#39;warn&#39;</span><span class="o">,</span> <span class="nx">NAME</span><span class="p">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Error reading or parsing JSON file: &quot;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">json</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_mojitPackageAsAsset</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pack</span><span class="o">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">pkg</span><span class="o">,</span> <span class="nx">packagePath</span><span class="o">,</span> <span class="nx">fakeResource</span><span class="o">;</span>

        <span class="nx">pkg</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pack</span><span class="p">.</span><span class="nx">yahoo</span> <span class="o">&amp;&amp;</span> <span class="nx">pack</span><span class="p">.</span><span class="nx">yahoo</span><span class="p">.</span><span class="nx">mojito</span> <span class="o">&amp;&amp;</span> <span class="nx">pack</span><span class="p">.</span><span class="nx">yahoo</span><span class="p">.</span><span class="nx">mojito</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">])</span> <span class="o">||</span>
            <span class="p">(</span><span class="nx">pack</span><span class="p">.</span><span class="nx">config</span> <span class="o">&amp;&amp;</span> <span class="nx">pack</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">mojito</span> <span class="o">&amp;&amp;</span> <span class="nx">pack</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">mojito</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pkg</span> <span class="o">===</span> <span class="s1">&#39;public&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c">// We have to check if the &quot;package.json&quot; files wants to do this</span>
            <span class="nx">packagePath</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">path</span><span class="o">,</span> <span class="s1">&#39;package.json&#39;</span><span class="p">);</span>
            <span class="nx">fakeResource</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;package&#39;</span><span class="o">,</span>
                <span class="nx">fsPath</span><span class="o">:</span> <span class="nx">packagePath</span>
            <span class="p">};</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_precalcStaticURL</span><span class="p">(</span><span class="nx">fakeResource</span><span class="o">,</span> <span class="p">(</span><span class="nx">pack</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">path</span><span class="p">)));</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_mojitoVersionMatch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pack</span><span class="o">,</span> <span class="nx">version</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">packageVersion</span><span class="o">;</span>
        <span class="c">// There was no package.json file so assume version is OK</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">pack</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="c">// If we have a version make sure it is less than the given one</span>
        <span class="nx">packageVersion</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pack</span><span class="p">.</span><span class="nx">yahoo</span> <span class="o">&amp;&amp;</span> <span class="nx">pack</span><span class="p">.</span><span class="nx">yahoo</span><span class="p">.</span><span class="nx">mojito</span> <span class="o">&amp;&amp;</span> <span class="nx">pack</span><span class="p">.</span><span class="nx">yahoo</span><span class="p">.</span><span class="nx">mojito</span><span class="p">.</span><span class="nx">version</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="nx">pack</span><span class="p">.</span><span class="nx">config</span> <span class="o">&amp;&amp;</span> <span class="nx">pack</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">mojito</span> <span class="o">&amp;&amp;</span> <span class="nx">pack</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">mojito</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">packageVersion</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">packageVersion</span> <span class="o">===</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="p">}</span>
            <span class="c">// TODO: [bug 4647440] Put real version checking code here</span>
            <span class="k">return</span> <span class="nx">packageVersion</span> <span class="o">&lt;=</span> <span class="nx">version</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="c">// No version is set so return false as we don&#39;t know what this is</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_cookdown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c">//logger.log(&#39;_cookdown()&#39;);</span>
        <span class="kd">var</span> <span class="nx">env</span><span class="o">,</span> <span class="nx">envs</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;client&#39;</span><span class="o">,</span> <span class="s1">&#39;server&#39;</span> <span class="p">]</span><span class="o">,</span>
            <span class="nx">type</span><span class="o">,</span> <span class="nx">i</span><span class="o">,</span> <span class="nx">merged</span><span class="o">,</span>
            <span class="nx">resid</span><span class="o">,</span> <span class="nx">resids</span><span class="o">,</span> <span class="nx">ctxKey</span><span class="o">;</span>

        <span class="c">// _preload.mojitMeta is </span>
        <span class="c">// [type][resid][affinity] = {</span>
        <span class="c">//      &quot;contexts&quot;: { &quot;device=iphone&quot;: { &quot;device&quot;:&quot;iphone&quot;} },</span>
        <span class="c">//      &quot;device=iphone&quot;: {</span>
        <span class="c">//          &quot;type&quot;: ...</span>
        <span class="c">//          &quot;fsPath&quot;: ...</span>
        <span class="c">//      }</span>
        <span class="c">// }</span>
        <span class="c">// resid was generated during _preloadFile*()</span>
        <span class="c">//      for example controller is &#39;controller&#39;</span>
        <span class="c">//      model is &#39;model-docs&#39;</span>
        <span class="c">//      view is &#39;view-index&#39;</span>
        <span class="c">// TODO DREW 2011-06-16: [bug 4647391] break down into smaller pieces (at least for more fine-grained unit testing)</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">type</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">mojitMeta</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">mojitMeta</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span> <span class="p">{</span>
                <span class="c">// TODO LINT 2011-06-16: [bug 4647450] detect dupe resids</span>
                <span class="nx">resids</span> <span class="o">=</span> <span class="p">{};</span>

                <span class="c">// need resids from all sources</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">fwMeta</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">fwMeta</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">resids</span><span class="p">[</span><span class="nx">resid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">appMeta</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">appMeta</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">resids</span><span class="p">[</span><span class="nx">resid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">mojitMeta</span><span class="p">[</span><span class="nx">type</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">mojitMeta</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">resids</span><span class="p">[</span><span class="nx">resid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="nx">resids</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">resids</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">envs</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">env</span> <span class="o">=</span> <span class="nx">envs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                            <span class="nx">merged</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cookdownMerge</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="p">[</span>
                                <span class="c">// ORDER IS IMPORTANT</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">fwMeta</span><span class="p">[</span><span class="nx">resid</span><span class="p">]</span><span class="o">,</span>             <span class="c">// source=fw</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">appMeta</span><span class="p">[</span><span class="nx">resid</span><span class="p">]</span><span class="o">,</span>            <span class="c">// source=app</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">mojitMeta</span><span class="p">[</span><span class="nx">type</span><span class="p">][</span><span class="nx">resid</span><span class="p">]</span>     <span class="c">// source=mojit</span>
                            <span class="p">]);</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">merged</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">])</span> <span class="p">{</span>
                                    <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                                <span class="p">}</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">type</span><span class="p">])</span> <span class="p">{</span>
                                    <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                                <span class="p">}</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">type</span><span class="p">].</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">type</span><span class="p">].</span><span class="nx">contexts</span> <span class="o">=</span> <span class="p">{};</span>
                                <span class="p">}</span>
                                <span class="k">for</span> <span class="p">(</span><span class="nx">ctxKey</span> <span class="k">in</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="nx">merged</span><span class="p">.</span><span class="nx">contexts</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">ctxKey</span><span class="p">))</span> <span class="p">{</span>
                                        <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">type</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">];</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">type</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">])</span> <span class="p">{</span>
                                            <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">type</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                                        <span class="p">}</span>
                                        <span class="c">// TODO DREW 2011-06-16: give example of datastructure</span>
                                        <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">type</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">][</span><span class="nx">resid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">merged</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">];</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                            <span class="p">}</span> <span class="c">// have merged</span>
                        <span class="p">}</span> <span class="c">// foreach env</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="c">// foreach resid</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="c">// foreach type</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">fwMeta</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">fwMeta</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">envs</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">env</span> <span class="o">=</span> <span class="nx">envs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="nx">merged</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cookdownMerge</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="p">[</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">fwMeta</span><span class="p">[</span><span class="nx">resid</span><span class="p">]</span>
                    <span class="p">]);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">merged</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_fwMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">])</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_fwMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_fwMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">].</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_fwMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">].</span><span class="nx">contexts</span> <span class="o">=</span> <span class="p">{};</span>
                        <span class="p">}</span>
                        <span class="k">for</span> <span class="p">(</span><span class="nx">ctxKey</span> <span class="k">in</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">merged</span><span class="p">.</span><span class="nx">contexts</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">ctxKey</span><span class="p">))</span> <span class="p">{</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_fwMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">];</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_fwMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">])</span> <span class="p">{</span>
                                    <span class="k">this</span><span class="p">.</span><span class="nx">_fwMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                                <span class="p">}</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_fwMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">][</span><span class="nx">resid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">merged</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">];</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">appMeta</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">appMeta</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">envs</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">env</span> <span class="o">=</span> <span class="nx">envs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="nx">merged</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cookdownMerge</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="p">[</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="p">.</span><span class="nx">appMeta</span><span class="p">[</span><span class="nx">resid</span><span class="p">]</span>
                    <span class="p">]);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">merged</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">])</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">].</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">].</span><span class="nx">contexts</span> <span class="o">=</span> <span class="p">{};</span>
                        <span class="p">}</span>
                        <span class="k">for</span> <span class="p">(</span><span class="nx">ctxKey</span> <span class="k">in</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">merged</span><span class="p">.</span><span class="nx">contexts</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">ctxKey</span><span class="p">))</span> <span class="p">{</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">merged</span><span class="p">.</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">];</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">])</span> <span class="p">{</span>
                                    <span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                                <span class="p">}</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_appMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">][</span><span class="nx">resid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">merged</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">];</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_preload</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_precalcYuiDependencies</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">e</span><span class="o">,</span> <span class="nx">i</span><span class="o">,</span> <span class="nx">env</span><span class="o">,</span> <span class="nx">envs</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;client&#39;</span><span class="o">,</span> <span class="s1">&#39;server&#39;</span> <span class="p">]</span><span class="o">,</span>
            <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">ctxKey</span><span class="o">,</span> <span class="nx">module</span><span class="o">,</span>
            <span class="nx">parts</span><span class="o">,</span> <span class="nx">required</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span>
            <span class="nx">sorted</span><span class="o">,</span> <span class="nx">ctxs</span><span class="o">,</span> <span class="nx">onlyLoadNecessary</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">e</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">e</span><span class="o">&lt;</span><span class="nx">envs</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">e</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">env</span> <span class="o">=</span> <span class="nx">envs</span><span class="p">[</span><span class="nx">e</span><span class="p">];</span>

            <span class="c">// mojit-specific</span>
            <span class="c">// --------------</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span><span class="p">[</span><span class="nx">env</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiRequired</span><span class="p">[</span><span class="nx">env</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span><span class="p">[</span><span class="nx">env</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSortedPaths</span><span class="p">[</span><span class="nx">env</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">mojitType</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">mojitType</span><span class="p">))</span> <span class="p">{</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">])</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiRequired</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSortedPaths</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="p">(</span><span class="nx">ctxKey</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">ctxKey</span><span class="p">))</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="o">===</span> <span class="nx">ctxKey</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">continue</span><span class="o">;</span>
                            <span class="p">}</span>
                            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiRequired</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span> <span class="o">=</span> <span class="p">{};</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span> <span class="o">=</span> <span class="p">{};</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSortedPaths</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span> <span class="o">=</span> <span class="p">{};</span>
                            <span class="p">}</span>

                            <span class="nx">parts</span> <span class="o">=</span> <span class="p">{};</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_precalcYuiDependencies_getDepParts</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">,</span> <span class="nx">parts</span><span class="p">);</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_precalcYuiDependencies_getDepParts</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">]</span><span class="o">,</span> <span class="nx">parts</span><span class="p">);</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">controller</span> <span class="o">&amp;&amp;</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="s1">&#39;inlinecss/&#39;</span><span class="o">+</span><span class="nx">mojitType</span><span class="p">])</span> <span class="p">{</span>
                                <span class="nx">parts</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">parts</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">].</span><span class="nx">requires</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;inlinecss/&#39;</span><span class="o">+</span><span class="nx">mojitType</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">]</span> <span class="o">=</span>
                                 <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">];</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiRequired</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">]</span> <span class="o">=</span>
                                 <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">];</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">controller</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">parts</span><span class="p">.</span><span class="nx">required</span><span class="p">[</span><span class="nx">parts</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                <span class="c">// dependencies necessary to dispatch the mojit</span>
                                <span class="nx">parts</span><span class="p">.</span><span class="nx">required</span><span class="p">[</span><span class="s1">&#39;mojito-dispatcher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                <span class="nx">sorted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sortYUIModules</span><span class="p">(</span>
                                    <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">]</span><span class="o">,</span>
                                    <span class="nx">env</span><span class="o">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">yui</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">modules</span><span class="o">,</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">required</span><span class="p">);</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiRequired</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">required</span><span class="p">);</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sorted</span><span class="p">.</span><span class="nx">sorted</span><span class="o">;</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSortedPaths</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sorted</span><span class="p">.</span><span class="nx">paths</span><span class="o">;</span>
                            <span class="p">}</span>

                            <span class="c">// also calculate sortedPaths for each individual binder</span>
                            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;client&#39;</span> <span class="o">===</span> <span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">])</span> <span class="p">{</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                                        <span class="nx">res</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">][</span><span class="nx">resid</span><span class="p">];</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;binder&#39;</span><span class="p">)</span> <span class="p">{</span>
                                            <span class="k">continue</span><span class="o">;</span>
                                        <span class="p">}</span>
                                        <span class="nx">required</span> <span class="o">=</span> <span class="p">{};</span>
                                        <span class="nx">required</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                        <span class="c">// all binders have this dependency, even if not explicitly given</span>
                                        <span class="nx">required</span><span class="p">[</span><span class="s1">&#39;mojito-client&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                        <span class="c">// view engines are needed to support mojitProxy.render()</span>
                                        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">viewEngines</span><span class="p">)</span> <span class="p">{</span>
                                            <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">viewEngines</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                                                <span class="nx">required</span><span class="p">[</span><span class="nx">parts</span><span class="p">.</span><span class="nx">viewEngines</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                            <span class="p">}</span>
                                        <span class="p">}</span>
                                        <span class="nx">sorted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sortYUIModules</span><span class="p">(</span>
                                             <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">]</span><span class="o">,</span>
                                             <span class="nx">env</span><span class="o">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">yui</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">modules</span><span class="o">,</span> <span class="nx">required</span><span class="p">);</span>
                                        <span class="nx">res</span><span class="p">.</span><span class="nx">yuiSortedPaths</span> <span class="o">=</span> <span class="nx">sorted</span><span class="p">.</span><span class="nx">paths</span><span class="o">;</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">}</span> <span class="c">// foreach context (except &#39;*&#39;)</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">])</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiRequired</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span> <span class="o">=</span> <span class="p">{};</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span> <span class="o">=</span> <span class="p">{};</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSortedPaths</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span> <span class="o">=</span> <span class="p">{};</span>
                        <span class="p">}</span>
                        <span class="nx">parts</span> <span class="o">=</span> <span class="p">{};</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">_precalcYuiDependencies_getDepParts</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">,</span> <span class="nx">parts</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">controller</span> <span class="o">&amp;&amp;</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="s1">&#39;inlinecss/&#39;</span><span class="o">+</span><span class="nx">mojitType</span><span class="p">])</span> <span class="p">{</span>
                            <span class="nx">parts</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">parts</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">].</span><span class="nx">requires</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;inlinecss/&#39;</span><span class="o">+</span><span class="nx">mojitType</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span> <span class="o">=</span>
                             <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">];</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiRequired</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span> <span class="o">=</span>
                             <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">controller</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">parts</span><span class="p">.</span><span class="nx">required</span><span class="p">[</span><span class="nx">parts</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                            <span class="c">// dependencies necessary to dispatch the mojit</span>
                            <span class="nx">parts</span><span class="p">.</span><span class="nx">required</span><span class="p">[</span><span class="s1">&#39;mojito-dispatcher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                            <span class="nx">sorted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sortYUIModules</span><span class="p">(</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">,</span>
                                <span class="nx">env</span><span class="o">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">yui</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">modules</span><span class="o">,</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">required</span><span class="p">);</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiRequired</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">required</span><span class="p">);</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSorted</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sorted</span><span class="p">.</span><span class="nx">sorted</span><span class="o">;</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">_mojitYuiSortedPaths</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sorted</span><span class="p">.</span><span class="nx">paths</span><span class="o">;</span>
                        <span class="p">}</span>

                        <span class="c">// also calculate sortedPaths for each individual binder</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;client&#39;</span> <span class="o">===</span> <span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">])</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                                    <span class="nx">res</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="nx">resid</span><span class="p">];</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;binder&#39;</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="k">continue</span><span class="o">;</span>
                                    <span class="p">}</span>
                                    <span class="nx">required</span> <span class="o">=</span> <span class="p">{};</span>
                                    <span class="nx">required</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                    <span class="c">// all binders have this dependency, even if not explicitly given</span>
                                    <span class="nx">required</span><span class="p">[</span><span class="s1">&#39;mojito-client&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                    <span class="c">// view engines are needed to support mojitProxy.render()</span>
                                    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">viewEngines</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">viewEngines</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                                            <span class="nx">required</span><span class="p">[</span><span class="nx">parts</span><span class="p">.</span><span class="nx">viewEngines</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                                        <span class="p">}</span>
                                    <span class="p">}</span>
                                    <span class="nx">sorted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_sortYUIModules</span><span class="p">(</span>
                                        <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojitType</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span><span class="o">,</span>
                                        <span class="nx">env</span><span class="o">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">yui</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">modules</span><span class="o">,</span> <span class="nx">required</span><span class="p">);</span>
                                    <span class="nx">res</span><span class="p">.</span><span class="nx">yuiSortedPaths</span> <span class="o">=</span> <span class="nx">sorted</span><span class="p">.</span><span class="nx">paths</span><span class="o">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="c">// context==&#39;*&#39;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="c">// foreach mojitType</span>
        <span class="p">}</span> <span class="c">// foreach env</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// fills dest with:</span>
    <span class="c">//  .controller     resource for the controller</span>
    <span class="c">//  .modules        hash yuiModuleName: {</span>
    <span class="c">//                          fullpath: where to load the module from</span>
    <span class="c">//                          requires: list of required modules</span>
    <span class="c">//                      }</span>
    <span class="c">//  .moduleSources  hash yuiModuleName:source</span>
    <span class="c">//  .required       hash yuiModuleName:true of modules required by the source controller</span>
    <span class="c">//  .viewEngines    hash name:yuiModuleName of view engines</span>
    <span class="nx">_precalcYuiDependencies_getDepParts</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">source</span><span class="o">,</span> <span class="nx">dest</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">viewEngine</span><span class="o">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="nx">dest</span><span class="p">.</span><span class="nx">required</span> <span class="o">=</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">required</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="nx">dest</span><span class="p">.</span><span class="nx">viewEngines</span> <span class="o">=</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">viewEngines</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="nx">dest</span><span class="p">.</span><span class="nx">modules</span> <span class="o">=</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">modules</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="nx">dest</span><span class="p">.</span><span class="nx">moduleSources</span> <span class="o">=</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">moduleSources</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c">// all mojits essentially have this dependency implicitly (even it not given explicitly)</span>
        <span class="nx">dest</span><span class="p">.</span><span class="nx">required</span><span class="p">.</span><span class="nx">mojito</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">res</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="nx">resid</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;view&#39;</span> <span class="o">===</span> <span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">viewEngine</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="s1">&#39;addon-view-engines-&#39;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">viewEngine</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">viewEngine</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">required</span><span class="p">[</span><span class="nx">viewEngine</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">viewEngines</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">viewEngine</span><span class="p">]</span> <span class="o">=</span> <span class="nx">viewEngine</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="o">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c">// The binder is part of the resources for the server,</span>
                    <span class="c">// but shouldn&#39;t be added as a runtime dependency.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;server&#39;</span> <span class="o">===</span> <span class="nx">env</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;binder&#39;</span> <span class="o">===</span> <span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;mojit&#39;</span> <span class="o">===</span> <span class="nx">res</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">required</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="p">}</span>
                    <span class="nx">dest</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="nx">requires</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleMeta</span><span class="p">.</span><span class="nx">requires</span><span class="o">,</span>
                        <span class="nx">fullpath</span><span class="o">:</span> <span class="p">((</span><span class="s1">&#39;client&#39;</span> <span class="o">===</span> <span class="nx">env</span><span class="p">)</span> <span class="o">?</span> <span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span> <span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">)</span>
                    <span class="p">};</span>
                    <span class="nx">dest</span><span class="p">.</span><span class="nx">moduleSources</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">source</span><span class="o">;</span>
                    <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;controller&#39;</span> <span class="o">===</span> <span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">dest</span><span class="p">.</span><span class="nx">controller</span> <span class="o">=</span> <span class="nx">res</span><span class="o">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c">// TODO 2011-08-10 -- move other dynamic dependency adjustments (compiled views inlinecss) here</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_precalcStaticURL</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="o">,</span> <span class="nx">mojitType</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">/* alternate approach which shows power of precalculating the URL and</span>
<span class="c">         * then passing it around everywhere</span>
<span class="c">        res.staticHandlerURL = &#39;/static/&#39; + Math.floor(Math.random() * 1000000000);</span>
<span class="c">        return;</span>
<span class="c">        */</span>
        <span class="kd">var</span> <span class="nx">url</span><span class="o">,</span> <span class="nx">parts</span> <span class="o">=</span> <span class="p">[]</span><span class="o">,</span>
            <span class="nx">path</span><span class="o">,</span> <span class="nx">i</span><span class="o">,</span> <span class="nx">relpath</span><span class="o">,</span>
            <span class="nx">config</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">staticHandling</span> <span class="o">||</span> <span class="p">{}</span><span class="o">,</span>
            <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">prefix</span><span class="o">,</span>
            <span class="nx">appName</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">appName</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">_shortRoot</span><span class="o">,</span>
            <span class="nx">frameworkName</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">frameworkName</span> <span class="o">||</span> <span class="s1">&#39;mojito&#39;</span><span class="o">,</span>
            <span class="nx">rollupParts</span> <span class="o">=</span> <span class="p">[]</span><span class="o">,</span> <span class="nx">rollupFsPath</span><span class="o">;</span>
            <span class="c">// TODO DREW: [bug 4647457] magic constants should should come from fw.json</span>

        <span class="c">/*</span>
<span class="c">        Server only framework mojits like DaliProxy and HTMLFrameMojit should never have static</span>
<span class="c">        URLs associated with them, so we skip them. This never used to be an issue until we added</span>
<span class="c">        the &quot;assumeRollups&quot; functionality to preload JSON specs for specified mojits during the</span>
<span class="c">        compile step (mojito compile json) for Livestand. I think we need to reevaluate this entire</span>
<span class="c">        process so we don&#39;t have such a fragile condition below. -- Matt</span>
<span class="c">         */</span>
        <span class="c">// TODO: reevaluate this entire process so we don&#39;t have such a fragile condition below.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mojitType</span> <span class="o">===</span> <span class="s1">&#39;DaliProxy&#39;</span> <span class="o">||</span> <span class="nx">mojitType</span> <span class="o">===</span> <span class="s1">&#39;HTMLFrameMojit&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="nx">switch</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">case</span> <span class="s1">&#39;action&#39;</span><span class="o">:</span>
                <span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;actions&#39;</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="nx">case</span> <span class="s1">&#39;addon&#39;</span><span class="o">:</span>
                <span class="nx">i</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/addons/&#39;</span><span class="p">);</span>
                <span class="nx">relpath</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span>
                <span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;addons&#39;</span><span class="o">,</span> <span class="nx">relpath</span><span class="p">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="nx">case</span> <span class="s1">&#39;asset&#39;</span><span class="o">:</span>
                <span class="nx">i</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/assets/&#39;</span><span class="p">);</span>
                <span class="nx">relpath</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span>
                <span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;assets&#39;</span><span class="o">,</span> <span class="nx">relpath</span><span class="p">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="nx">case</span> <span class="s1">&#39;binder&#39;</span><span class="o">:</span>
                <span class="nx">i</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/binders/&#39;</span><span class="p">);</span>
                <span class="nx">relpath</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">9</span><span class="p">);</span>
                <span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;binders&#39;</span><span class="o">,</span> <span class="nx">relpath</span><span class="p">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="nx">case</span> <span class="s1">&#39;controller&#39;</span><span class="o">:</span>
                <span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="nx">case</span> <span class="s1">&#39;model&#39;</span><span class="o">:</span>
                <span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;models&#39;</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="nx">case</span> <span class="s1">&#39;view&#39;</span><span class="o">:</span>
                <span class="nx">i</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/views/&#39;</span><span class="p">);</span>
                <span class="nx">relpath</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">7</span><span class="p">);</span>
                <span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="o">,</span> <span class="nx">relpath</span><span class="p">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="nx">case</span> <span class="s1">&#39;yui-lang&#39;</span><span class="o">:</span>
                <span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="o">,</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="nx">case</span> <span class="s1">&#39;yui-module&#39;</span><span class="o">:</span>
                <span class="nx">i</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/autoload/&#39;</span><span class="p">);</span>
                <span class="nx">relpath</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">10</span><span class="p">);</span>
                <span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;autoload&#39;</span><span class="o">,</span> <span class="nx">relpath</span><span class="p">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="nx">case</span> <span class="s1">&#39;package&#39;</span><span class="o">:</span>
                <span class="nx">path</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="nx">default</span><span class="o">:</span>
                <span class="k">return</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">config</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;prefix&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">prefix</span> <span class="o">=</span> <span class="s1">&#39;static&#39;</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">parts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">prefix</span><span class="p">);</span>
            <span class="nx">rollupParts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">prefix</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;fw&#39;</span> <span class="o">===</span> <span class="nx">res</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">parts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">frameworkName</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">useRollups</span> <span class="o">&amp;&amp;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">)</span> <span class="p">{</span>
                <span class="c">// fw resources are put into app-level rollup</span>
                <span class="nx">rollupParts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">appName</span><span class="p">);</span>
                <span class="nx">rollupFsPath</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_root</span><span class="o">,</span> <span class="s1">&#39;rollup.client.js&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;app&#39;</span> <span class="o">===</span> <span class="nx">res</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">parts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">appName</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">useRollups</span> <span class="o">&amp;&amp;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">rollupParts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">appName</span><span class="p">);</span>
                <span class="nx">rollupFsPath</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_root</span><span class="o">,</span> <span class="s1">&#39;rollup.client.js&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">parts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mojitType</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">useRollups</span> <span class="o">&amp;&amp;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">rollupParts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mojitType</span><span class="p">);</span>
                <span class="nx">rollupFsPath</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitPaths</span><span class="p">[</span><span class="nx">mojitType</span><span class="p">]</span><span class="o">,</span> <span class="s1">&#39;rollup.client.js&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mojitType</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitAssetRoots</span><span class="p">[</span><span class="nx">mojitType</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">_mojitAssetRoots</span><span class="p">[</span><span class="nx">mojitType</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">,</span> <span class="s1">&#39;assets&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c">// only use rollup URL if rollup file exists or we are assuming rollups</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">rollupFsPath</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">rollupFsPath</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">config</span><span class="p">.</span><span class="nx">useRollups</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">_appConfigNC</span><span class="p">.</span><span class="nx">assumeRollups</span><span class="p">)</span> <span class="p">{</span>
            <span class="c">// useful for debugging:  path += &#39;?orig=&#39; + path;</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">rollupURL</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">rollupParts</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">,</span> <span class="s1">&#39;rollup.client.js&#39;</span><span class="p">);</span>
            <span class="nx">url</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rollupURL</span><span class="o">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_staticURLs</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rollupFsPath</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">,</span> <span class="nx">path</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">_staticURLs</span><span class="p">[</span><span class="nx">url</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">staticHandlerURL</span> <span class="o">=</span> <span class="nx">url</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// attempt to gather YUI-module details</span>
    <span class="nx">_precalcYuiModule</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_libs</span><span class="p">.</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span><span class="o">,</span>
            <span class="nx">ctx</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">console</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">log</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
                <span class="p">}</span><span class="o">,</span>
                <span class="nb">window</span><span class="o">:</span> <span class="p">{}</span><span class="o">,</span>
                <span class="nb">document</span><span class="o">:</span> <span class="p">{}</span><span class="o">,</span>
                <span class="nx">YUI</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="o">,</span><span class="nx">fn</span><span class="o">,</span><span class="nx">version</span><span class="o">,</span><span class="nx">meta</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleName</span> <span class="o">=</span> <span class="nx">name</span><span class="o">;</span>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleVersion</span> <span class="o">=</span> <span class="nx">version</span><span class="o">;</span>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">yuiModuleMeta</span> <span class="o">=</span> <span class="nx">meta</span> <span class="o">||</span> <span class="p">{};</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">};</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">libvm</span><span class="p">.</span><span class="nx">runInNewContext</span><span class="p">(</span><span class="nx">file</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;SyntaxError:&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="c">// the stack of a SyntaxError thrown by runInNewContext() lacks</span>
                <span class="c">// filename, line and column numbers for the error. Also, it does</span>
                <span class="c">// not write to stderr as the docs claim.</span>

                <span class="c">// see &quot;Lack of error message in vm.* stuff&quot; from 2011-04-29 at</span>
                <span class="c">// http://groups.google.com/group/nodejs/browse_thread/thread/2075b964a3f7dd79/bd0df1ae36829813</span>

                <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_reportJavaScriptSyntaxErrors</span><span class="p">(</span><span class="nx">file</span><span class="p">));</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span> <span class="o">+</span> <span class="s1">&#39; in file: &#39;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="o">,</span> <span class="s1">&#39;error&#39;</span><span class="o">,</span> <span class="nx">NAME</span><span class="p">);</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="o">,</span> <span class="s1">&#39;error&#39;</span><span class="o">,</span> <span class="nx">NAME</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_getMojitConfig</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">mojitIn</span><span class="o">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">//logger.log(&#39;_getMojitConfig(&#39;+env+&#39;,&#39;+mojitIn+&#39;,&#39;+name+&#39;)&#39;);</span>
        <span class="kd">var</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">mojit</span><span class="o">,</span>
            <span class="nx">appConfig</span><span class="o">,</span> <span class="nx">specs</span><span class="o">,</span> <span class="nx">spec</span><span class="o">;</span>

        <span class="nx">mojit</span> <span class="o">=</span> <span class="nx">mojitIn</span><span class="o">;</span>
        <span class="nx">resid</span> <span class="o">=</span> <span class="s1">&#39;config-&#39;</span> <span class="o">+</span> <span class="nx">name</span><span class="o">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojit</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Cannot find meta data for mojit type \&quot;&quot;</span> <span class="o">+</span> <span class="nx">mojit</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">res</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getContextualizedResource</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_mojitMeta</span><span class="p">[</span><span class="nx">env</span><span class="p">][</span><span class="nx">mojit</span><span class="p">]</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">resid</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_readConfigYCB</span><span class="p">(</span><span class="nx">ctx</span><span class="o">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fsPath</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_sortYUIModules</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="o">,</span> <span class="nx">env</span><span class="o">,</span> <span class="nx">yuiConfig</span><span class="o">,</span> <span class="nx">mojitType</span><span class="o">,</span> <span class="nx">modules</span><span class="o">,</span> <span class="nx">required</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">Y</span><span class="o">,</span> <span class="nx">loader</span><span class="o">,</span> <span class="nx">sortedPaths</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span> <span class="nx">j</span><span class="o">,</span> <span class="nx">module</span><span class="o">,</span> <span class="nx">info</span><span class="o">;</span>
        <span class="nx">Y</span> <span class="o">=</span> <span class="nx">YUI</span><span class="p">().</span><span class="nx">useSync</span><span class="p">(</span><span class="s1">&#39;loader-base&#39;</span><span class="p">);</span>
        <span class="nx">loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Y</span><span class="p">.</span><span class="nx">Loader</span><span class="p">({</span> <span class="nx">lang</span><span class="o">:</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">lang</span> <span class="p">});</span>

        <span class="c">// We need to clear YUI&#39;s cached dependencies, since there&#39;s no guarantee that</span>
        <span class="c">// the previously calculated dependencies have been done using the same context</span>
        <span class="c">// as this calculation.</span>
        <span class="nx">delete</span> <span class="nx">YUI</span><span class="p">.</span><span class="nx">Env</span><span class="p">.</span><span class="nx">_renderedMods</span><span class="o">;</span>

        <span class="c">// This approach seems odd, but it&#39;s what the YUI Configurator is also doing.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">yuiConfig</span> <span class="o">&amp;&amp;</span> <span class="nx">yuiConfig</span><span class="p">.</span><span class="nx">base</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">loader</span><span class="p">.</span><span class="nx">base</span> <span class="o">=</span> <span class="nx">yuiConfig</span><span class="p">.</span><span class="nx">base</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">loader</span><span class="p">.</span><span class="nx">base</span> <span class="o">=</span> <span class="nx">Y</span><span class="p">.</span><span class="nx">Env</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">base</span> <span class="o">+</span> <span class="nx">Y</span><span class="p">.</span><span class="nx">Env</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">root</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="nx">loader</span><span class="p">.</span><span class="nx">addGroup</span><span class="p">({</span><span class="nx">modules</span><span class="o">:</span> <span class="nx">modules</span><span class="p">}</span><span class="o">,</span> <span class="nx">mojitType</span><span class="p">);</span>
        <span class="nx">loader</span><span class="p">.</span><span class="nx">calculate</span><span class="p">({</span><span class="nx">required</span><span class="o">:</span> <span class="nx">required</span><span class="p">});</span>
        <span class="c">// This is required because loader.calculate() isn&#39;t taking into consideration</span>
        <span class="c">// conditional modules.</span>
        <span class="c">// http://yuilibrary.com/projects/yui3/ticket/2530343</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;server&#39;</span> <span class="o">===</span> <span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">loader</span><span class="p">.</span><span class="nx">sorted</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="s1">&#39;io-nodejs&#39;</span><span class="p">);</span>
            <span class="nx">loader</span><span class="p">.</span><span class="nx">sorted</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="s1">&#39;nodejs-node&#39;</span><span class="p">);</span>
            <span class="nx">loader</span><span class="p">.</span><span class="nx">sorted</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="s1">&#39;nodejs-dom&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">loader</span><span class="p">.</span><span class="nx">sorted</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">module</span> <span class="o">=</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">sorted</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
            <span class="nx">info</span> <span class="o">=</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">moduleInfo</span><span class="p">[</span><span class="nx">module</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">sortedPaths</span><span class="p">[</span><span class="nx">module</span><span class="p">]</span> <span class="o">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">fullpath</span> <span class="o">||</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">_url</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span> <span class="nx">sorted</span><span class="o">:</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">sorted</span><span class="o">,</span> <span class="nx">paths</span><span class="o">:</span> <span class="nx">sortedPaths</span> <span class="p">};</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_matchContext</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="o">,</span> <span class="nx">ctxParts</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">k</span><span class="o">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">ctxParts</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">ctxParts</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">k</span><span class="p">))</span> <span class="p">{</span>
                <span class="c">// FUTURE -- handle &quot;lang&quot; slightly specially (&quot;en&quot; should match &quot;en-US&quot;)</span>
                <span class="c">// For now we will skip the &quot;lang&quot; check as is could change on the fly in the client</span>
                <span class="c">// and we need all the &quot;lang&quot; files avaliable in our YUI instance.</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">k</span> <span class="o">!==</span> <span class="s1">&#39;lang&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">ctx</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">ctxParts</span><span class="p">[</span><span class="nx">k</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_getResourceListForContext</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">src</span><span class="o">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>  <span class="c">// key: value</span>
            <span class="nx">key</span><span class="o">,</span> <span class="nx">ctxKey</span><span class="o">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">src</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">src</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">src</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">list</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">src</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="nx">key</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">ctxKey</span> <span class="k">in</span> <span class="nx">src</span><span class="p">.</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">contexts</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">ctxKey</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="o">===</span> <span class="nx">ctxKey</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_matchContext</span><span class="p">(</span><span class="nx">ctx</span><span class="o">,</span> <span class="nx">src</span><span class="p">.</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">src</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">src</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">list</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">src</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">][</span><span class="nx">key</span><span class="p">];</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">list</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_getLangList</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="p">{}</span><span class="o">,</span>  <span class="c">// resid: res</span>
            <span class="nx">ctxKey</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">ctxKey</span> <span class="k">in</span> <span class="nx">src</span><span class="p">.</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">contexts</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">ctxKey</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">resid</span> <span class="k">in</span> <span class="nx">src</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">src</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">resid</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">res</span> <span class="o">=</span> <span class="nx">src</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">][</span><span class="nx">resid</span><span class="p">];</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;yui-lang&#39;</span> <span class="o">===</span> <span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">list</span><span class="p">[</span><span class="nx">resid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="o">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">list</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// TODO DREW 2011-06-16: [bug 4647391] more comments, example, etc.  get knuthy</span>
    <span class="c">// this is an &quot;affinity resolver&quot;</span>
    <span class="nx">_cookdownMerge</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">env</span><span class="o">,</span> <span class="nx">srcs</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">merged</span> <span class="o">=</span> <span class="p">{</span><span class="nx">contexts</span><span class="o">:</span> <span class="p">{}}</span><span class="o">,</span>
            <span class="nx">affinities</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;common&#39;</span><span class="o">,</span> <span class="nx">env</span> <span class="p">]</span><span class="o">,</span>
            <span class="nx">s</span><span class="o">,</span> <span class="nx">src</span><span class="o">,</span> <span class="nx">lastS</span> <span class="o">=</span> <span class="nx">srcs</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span>
            <span class="nx">found</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span>  <span class="c">// TODO DREW 2011-06-16: when is found==false?</span>
            <span class="nx">a</span><span class="o">,</span> <span class="nx">affinity</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">ctxKey</span><span class="o">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">s</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">s</span><span class="o">&lt;</span><span class="nx">srcs</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">s</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">src</span> <span class="o">=</span> <span class="nx">srcs</span><span class="p">[</span><span class="nx">s</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">a</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">a</span><span class="o">&lt;</span><span class="nx">affinities</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">a</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">affinity</span> <span class="o">=</span> <span class="nx">affinities</span><span class="p">[</span><span class="nx">a</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">src</span><span class="p">[</span><span class="nx">affinity</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">ctxKey</span> <span class="k">in</span> <span class="nx">src</span><span class="p">[</span><span class="nx">affinity</span><span class="p">].</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">src</span><span class="p">[</span><span class="nx">affinity</span><span class="p">].</span><span class="nx">contexts</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">ctxKey</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">merged</span><span class="p">.</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">src</span><span class="p">[</span><span class="nx">affinity</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">];</span>
                        <span class="nx">res</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cloneObj</span><span class="p">(</span><span class="nx">src</span><span class="p">[</span><span class="nx">affinity</span><span class="p">][</span><span class="nx">ctxKey</span><span class="p">]);</span>
                        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;config&#39;</span> <span class="o">===</span> <span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">s</span> <span class="o">!==</span> <span class="nx">lastS</span><span class="p">))</span> <span class="p">{</span>
                            <span class="c">// only pull in configs from the last source</span>
                            <span class="k">continue</span><span class="o">;</span>
                        <span class="p">}</span>
                        <span class="nx">merged</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="o">;</span>
                        <span class="nx">merged</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="o">;</span>
                        <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">found</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">merged</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_getContextualizedResource</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">src</span><span class="o">,</span> <span class="nx">ctx</span><span class="o">,</span> <span class="nx">resid</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ctxKey</span><span class="o">,</span> <span class="nx">res</span><span class="o">;</span>

        <span class="c">// TODO: [bug 4647333] Review, Ric added this for when there is no app.json file</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">src</span> <span class="o">||</span> <span class="o">!</span><span class="nx">src</span><span class="p">.</span><span class="nx">contexts</span><span class="p">){</span>
            <span class="k">return</span> <span class="p">{};</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">ctxKey</span> <span class="k">in</span> <span class="nx">src</span><span class="p">.</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">contexts</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">ctxKey</span><span class="p">))</span> <span class="p">{</span>
                <span class="c">// look for specific first</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="o">===</span> <span class="nx">ctxKey</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_matchContext</span><span class="p">(</span><span class="nx">ctx</span><span class="o">,</span> <span class="nx">src</span><span class="p">.</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="p">}</span>
                <span class="nx">res</span> <span class="o">=</span> <span class="nx">src</span><span class="p">[</span><span class="nx">ctxKey</span><span class="p">][</span><span class="nx">resid</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">res</span><span class="o">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c">// fallback</span>
        <span class="k">return</span> <span class="nx">src</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="nx">resid</span><span class="p">];</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_preloadSetDest</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">resid</span><span class="o">,</span> <span class="nx">res</span><span class="o">,</span> <span class="nx">pathParts</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dest</span><span class="p">[</span><span class="nx">resid</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">dest</span><span class="p">[</span><span class="nx">resid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="nx">dest</span> <span class="o">=</span> <span class="nx">dest</span><span class="p">[</span><span class="nx">resid</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dest</span><span class="p">[</span><span class="nx">pathParts</span><span class="p">.</span><span class="nx">affinity</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">dest</span><span class="p">[</span><span class="nx">pathParts</span><span class="p">.</span><span class="nx">affinity</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="nx">dest</span> <span class="o">=</span> <span class="nx">dest</span><span class="p">[</span><span class="nx">pathParts</span><span class="p">.</span><span class="nx">affinity</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dest</span><span class="p">.</span><span class="nx">contexts</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dest</span><span class="p">.</span><span class="nx">contexts</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="nx">dest</span><span class="p">.</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">pathParts</span><span class="p">.</span><span class="nx">contextKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pathParts</span><span class="p">.</span><span class="nx">contextParts</span><span class="o">;</span>
        <span class="nx">dest</span><span class="p">[</span><span class="nx">pathParts</span><span class="p">.</span><span class="nx">contextKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// TODO DREW 2011-06-16: [bug 4647391] comment this stuff</span>
    <span class="nx">_parsePath</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fullpath</span><span class="o">,</span> <span class="nx">defaultAffinity</span><span class="o">,</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">shortpath</span><span class="o">,</span> <span class="nx">reldir</span><span class="o">,</span> <span class="nx">parts</span><span class="o">,</span> <span class="nx">outParts</span> <span class="o">=</span> <span class="p">[]</span><span class="o">,</span>
            <span class="nx">i</span><span class="o">,</span> <span class="nx">part</span><span class="o">,</span> <span class="nx">device</span><span class="o">,</span> <span class="nx">affinity</span><span class="o">,</span>
            <span class="nx">out</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">contextKey</span><span class="o">:</span> <span class="s1">&#39;*&#39;</span><span class="o">,</span>
                <span class="nx">contextParts</span><span class="o">:</span> <span class="p">{}</span><span class="o">,</span>
                <span class="nx">affinity</span><span class="o">:</span> <span class="nx">defaultAffinity</span> <span class="o">||</span> <span class="s1">&#39;server&#39;</span>
            <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dir</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dir</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">dir</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">dir</span><span class="o">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
        <span class="nx">out</span><span class="p">.</span><span class="nx">relpath</span> <span class="o">=</span> <span class="nx">fullpath</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">dir</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

        <span class="c">// TODO -- support strict {name}.{selector}?.{affinity}?.{ext} syntax</span>
        <span class="nx">out</span><span class="p">.</span><span class="nx">ext</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">fullpath</span><span class="p">);</span>
        <span class="nx">shortpath</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">out</span><span class="p">.</span><span class="nx">relpath</span><span class="o">,</span> <span class="nx">out</span><span class="p">.</span><span class="nx">ext</span><span class="p">);</span>
        <span class="nx">reldir</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">out</span><span class="p">.</span><span class="nx">relpath</span><span class="p">);</span>

        <span class="nx">affinity</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_detectAffinityFromShortFilename</span><span class="p">(</span><span class="nx">shortpath</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">affinity</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">out</span><span class="p">.</span><span class="nx">affinity</span> <span class="o">=</span> <span class="nx">affinity</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="nx">device</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_detectDeviceFromShortFilename</span><span class="p">(</span><span class="nx">shortpath</span><span class="o">,</span> <span class="nx">out</span><span class="p">.</span><span class="nx">contextParts</span><span class="p">.</span><span class="nx">device</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">device</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">out</span><span class="p">.</span><span class="nx">contextParts</span><span class="p">.</span><span class="nx">device</span> <span class="o">=</span> <span class="nx">device</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="nx">outParts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_extractRootNameFromShortFilename</span><span class="p">(</span><span class="nx">shortpath</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_objectIsEmpty</span><span class="p">(</span><span class="nx">out</span><span class="p">.</span><span class="nx">contextParts</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">out</span><span class="p">.</span><span class="nx">contextKey</span> <span class="o">=</span> <span class="nx">libqs</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">out</span><span class="p">.</span><span class="nx">contextParts</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">out</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">reldir</span><span class="o">,</span> <span class="nx">outParts</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">));</span>
        <span class="nx">out</span><span class="p">.</span><span class="nx">shortpath</span> <span class="o">=</span> <span class="nx">libpath</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">reldir</span><span class="o">,</span> <span class="nx">shortpath</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">out</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">/*</span>
<span class="c">     * Generate a report of syntax errors for JavaScript code. This is also</span>
<span class="c">     * very useful to find syntax errors in JSON documents.</span>
<span class="c">     *</span>
<span class="c">     * @param {string} js the JavaScript</span>
<span class="c">     * @param {string} filename OPTIONAL. the name of the file containing the JavaScript</span>
<span class="c">     * @return {string} if errors were found, a multi-line error report</span>
<span class="c">     */</span>
    <span class="nx">_reportJavaScriptSyntaxErrors</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">js</span><span class="o">,</span> <span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>

        <span class="c">// use a really lenient JSLINT to find syntax errors</span>

        <span class="kd">var</span> <span class="nx">JSLINT</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./management/fulljslint&#39;</span><span class="p">).</span><span class="nx">JSLINT</span><span class="o">,</span>
            <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c">// turn off all the usual checks</span>
                <span class="nx">devel</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">browser</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">node</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">rhino</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">widget</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">windows</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span>
                <span class="nx">bitwise</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">regexp</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">confusion</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">undef</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="s1">&#39;continue&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span>
                <span class="nx">unparam</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">debug</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">sloppy</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">eqeq</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">sub</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">es5</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span>
                <span class="nx">vars</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">evil</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">white</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">forin</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">css</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">newcap</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span>
                <span class="nx">cap</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">nomen</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">on</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">plusplus</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span> <span class="nx">fragment</span><span class="o">:</span> <span class="kc">true</span><span class="o">,</span>

                <span class="c">// prevent well-known globals from showing up as errors</span>
                <span class="nx">predef</span><span class="o">:</span><span class="p">[</span>
                    <span class="s2">&quot;exports&quot;</span><span class="o">,</span> <span class="c">// CommonJS</span>
                    <span class="s2">&quot;YUI&quot;</span><span class="o">,</span> <span class="s2">&quot;YUI_config&quot;</span><span class="o">,</span> <span class="s2">&quot;YAHOO&quot;</span><span class="o">,</span> <span class="s2">&quot;YAHOO_config&quot;</span><span class="o">,</span> <span class="s2">&quot;Y&quot;</span><span class="o">,</span> <span class="c">// YUI</span>
                    <span class="s2">&quot;global&quot;</span><span class="o">,</span> <span class="s2">&quot;process&quot;</span><span class="o">,</span><span class="s2">&quot;require&quot;</span><span class="o">,</span> <span class="s2">&quot;__filename&quot;</span><span class="o">,</span> <span class="s2">&quot;module&quot;</span><span class="o">,</span> <span class="c">// Node</span>
                    <span class="s2">&quot;document&quot;</span><span class="o">,</span> <span class="s2">&quot;navigator&quot;</span><span class="o">,</span> <span class="s2">&quot;console&quot;</span><span class="o">,</span> <span class="s2">&quot;self&quot;</span><span class="o">,</span> <span class="s2">&quot;window&quot;</span> <span class="c">// Browser</span>
                <span class="p">]</span>
            <span class="p">}</span><span class="o">,</span>
            <span class="c">// identify errors about undefined globals</span>
            <span class="nx">nameIsNotDefined</span> <span class="o">=</span> <span class="sr">/ is not defined.$/</span><span class="o">,</span>
            <span class="nx">success</span><span class="o">,</span>
            <span class="nx">report</span> <span class="o">=</span> <span class="p">[]</span><span class="o">,</span>
            <span class="nx">len</span><span class="o">,</span>
            <span class="nx">e</span><span class="o">,</span>
            <span class="nx">i</span><span class="o">;</span>

        <span class="nx">success</span> <span class="o">=</span> <span class="nx">JSLINT</span><span class="p">(</span><span class="nx">js</span><span class="o">,</span> <span class="nx">opts</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">len</span> <span class="o">=</span> <span class="nx">JSLINT</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">e</span> <span class="o">=</span> <span class="nx">JSLINT</span><span class="p">.</span><span class="nx">errors</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">reason</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">nameIsNotDefined</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">reason</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">report</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">line</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">character</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
                    <span class="nx">report</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">evidence</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s+|\s+$/</span><span class="o">,</span> <span class="s1">&#39;&#39;</span><span class="p">));</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">filename</span> <span class="o">&amp;&amp;</span> <span class="nx">report</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">report</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="s1">&#39;Syntax errors detected in &#39;</span> <span class="o">+</span> <span class="nx">filename</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">report</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_detectAffinityFromShortFilename</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">affinity</span><span class="o">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">affinity</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Affinity</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">affinity</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="nx">_detectDeviceFromShortFilename</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="c">// FUTURE: [bug 4647471]real device detection</span>
        <span class="kd">var</span> <span class="nx">device</span><span class="o">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;iphone&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">device</span> <span class="o">=</span> <span class="s1">&#39;iphone&#39;</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">device</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="nx">_selectorFromContext</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">device</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">device</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="nx">_extractRootNameFromShortFilename</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">parts</span><span class="o">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">name</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="nx">parts</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="nx">parts</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>

    <span class="nx">_objectIsEmpty</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span> <span class="o">===</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">o</span><span class="p">).</span><span class="nx">length</span><span class="p">);</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="c">// from http://stackoverflow.com/questions/171251/how-can-i-merge-properties-of-two-javascript-objects-dynamically/383245#383245</span>
    <span class="c">/*</span>
<span class="c">    * Recursively merge properties of two objects </span>
<span class="c">    */</span>
    <span class="nx">_mergeRecursive</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dest</span><span class="o">,</span> <span class="nx">src</span><span class="o">,</span> <span class="nx">typeMatch</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">p</span><span class="o">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">p</span> <span class="k">in</span> <span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">p</span><span class="p">))</span> <span class="p">{</span>
                <span class="c">// Property in destination object set; update its value.</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">src</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">src</span><span class="p">[</span><span class="nx">p</span><span class="p">].</span><span class="nx">constructor</span> <span class="o">===</span> <span class="nb">Object</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">dest</span><span class="p">[</span><span class="nx">p</span><span class="p">]){</span>
                        <span class="nx">dest</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                    <span class="p">}</span>
                    <span class="nx">dest</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_mergeRecursive</span><span class="p">(</span><span class="nx">dest</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span><span class="o">,</span> <span class="nx">src</span><span class="p">[</span><span class="nx">p</span><span class="p">]);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">dest</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">typeMatch</span><span class="p">){</span>
                        <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">dest</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">src</span><span class="p">[</span><span class="nx">p</span><span class="p">]){</span>
                            <span class="nx">dest</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">src</span><span class="p">[</span><span class="nx">p</span><span class="p">];</span>
                        <span class="p">}</span>
                    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                        <span class="nx">dest</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">src</span><span class="p">[</span><span class="nx">p</span><span class="p">];</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">dest</span><span class="o">;</span>
    <span class="p">}</span><span class="o">,</span>


    <span class="nx">_cloneObj</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">newO</span><span class="o">,</span> <span class="nx">i</span><span class="o">;</span>

        <span class="k">if</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">o</span><span class="o">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">o</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;[object Array]&#39;</span> <span class="o">===</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">o</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">newO</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">o</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">newO</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cloneObj</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">newO</span><span class="o">;</span>
        <span class="p">}</span>

        <span class="nx">newO</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">newO</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_cloneObj</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">newO</span><span class="o">;</span>
    <span class="p">}</span>

<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">ServerStore</span><span class="o">;</span>
</pre></div>
                    </div>
			</div>
		</div>
		<div class="yui-b">
            <div class="nav">

                    <div id="moduleList" class="module">
                        <h4>Modules</h4>
                        <ul class="content">
                                <li class=""><a href="module_ActionContext.html" title="ActionContext">ActionContext</a></li>
                                <li class=""><a href="module_ActionContextAddon.html" title="ActionContextAddon">ActionContextAddon</a></li>
                                <li class=""><a href="module_CommonLibs.html" title="CommonLibs">CommonLibs</a></li>
                                <li class=""><a href="module_MojitoClient.html" title="MojitoClient">MojitoClient</a></li>
                                <li class="selected"><a href="module_MojitoServer.html" title="MojitoServer">MojitoServer</a></li>
                        </ul>
                    </div>

                    <div id="classList" class="module">
                        <h4>Classes</h4>
                        <ul class="content">
                                <li class=""><a href="Composite.common.html" title="Composite.common">Composite.common</a></li>
                                <li class=""><a href="Config.common.html" title="Config.common">Config.common</a></li>
                                <li class=""><a href="Cookie.client.html" title="Cookie.client">Cookie.client</a></li>
                                <li class=""><a href="Cookie.server.html" title="Cookie.server">Cookie.server</a></li>
                                <li class=""><a href="Http.server.html" title="Http.server">Http.server</a></li>
                                <li class=""><a href="Intl.common.html" title="Intl.common">Intl.common</a></li>
                                <li class=""><a href="MojitoServer.html" title="MojitoServer">MojitoServer</a></li>
                                <li class=""><a href="Params.common.html" title="Params.common">Params.common</a></li>
                                <li class=""><a href="Partial.common.html" title="Partial.common">Partial.common</a></li>
                                <li class=""><a href="Url.common.html" title="Url.common">Url.common</a></li>
                        </ul>
                    </div>

                    <!--
                    <div id="fileList" class="module">
                        <h4>Files</h4>
                        <ul class="content">        
                                <li class=""><a href="analytics.common.js.html" title="analytics.common.js">analytics.common.js</a></li>
                                <li class=""><a href="composite.common.js.html" title="composite.common.js">composite.common.js</a></li>
                                <li class=""><a href="config.common.js.html" title="config.common.js">config.common.js</a></li>
                                <li class=""><a href="controller.common.js.html" title="controller.common.js">controller.common.js</a></li>
                                <li class=""><a href="controller.server.js.html" title="controller.server.js">controller.server.js</a></li>
                                <li class=""><a href="controller.server.js.html" title="controller.server.js">controller.server.js</a></li>
                                <li class=""><a href="cookie.client.js.html" title="cookie.client.js">cookie.client.js</a></li>
                                <li class=""><a href="cookie.server.js.html" title="cookie.server.js">cookie.server.js</a></li>
                                <li class=""><a href="glob.js.html" title="glob.js">glob.js</a></li>
                                <li class=""><a href="http.server.js.html" title="http.server.js">http.server.js</a></li>
                                <li class=""><a href="index.js.html" title="index.js">index.js</a></li>
                                <li class=""><a href="index.js.html" title="index.js">index.js</a></li>
                                <li class=""><a href="intl.common.js.html" title="intl.common.js">intl.common.js</a></li>
                                <li class=""><a href="mu.client.js.html" title="mu.client.js">mu.client.js</a></li>
                                <li class=""><a href="mu.server.js.html" title="mu.server.js">mu.server.js</a></li>
                                <li class=""><a href="output-handler.server.js.html" title="output-handler.server.js">output-handler.server.js</a></li>
                                <li class=""><a href="params.common.js.html" title="params.common.js">params.common.js</a></li>
                                <li class=""><a href="partial.common.js.html" title="partial.common.js">partial.common.js</a></li>
                                <li class=""><a href="server-log.js.html" title="server-log.js">server-log.js</a></li>
                                <li class=""><a href="store-provider.server.js.html" title="store-provider.server.js">store-provider.server.js</a></li>
                                <li class="selected"><a href="store.server.js.html" title="store.server.js">store.server.js</a></li>
                                <li class=""><a href="url.common.js.html" title="url.common.js">url.common.js</a></li>
                        </ul>
                    </div>
                    -->





            </div>
		</div>
	</div>
	<div id="ft">
        <hr />
        Copyright &copy; 2012 Yahoo! Inc. All rights reserved.
	</div>
</div>
<script type="text/javascript">
    ALL_YUI_PROPS = [{"url": "Http.server.html#method_addHeader", "access": "", "host": "Http.server", "type": "method", "name": "addHeader"}, {"url": "Http.server.html#method_addHeaders", "access": "", "host": "Http.server", "type": "method", "name": "addHeaders"}, {"url": "MojitoServer.html#method_addMojitoToExpressApp", "access": "", "host": "MojitoServer", "type": "method", "name": "addMojitoToExpressApp"}, {"url": "Params.common.html#method_all", "access": "", "host": "Params.common", "type": "method", "name": "all"}, {"url": "Params.common.html#method_body", "access": "", "host": "Params.common", "type": "method", "name": "body"}, {"url": "MojitoServer.html#method_createServer", "access": "", "host": "MojitoServer", "type": "method", "name": "createServer"}, {"url": "Composite.common.html#method_done", "access": "", "host": "Composite.common", "type": "method", "name": "done"}, {"url": "Composite.common.html#method_execute", "access": "", "host": "Composite.common", "type": "method", "name": "execute"}, {"url": "Params.common.html#method_files", "access": "", "host": "Params.common", "type": "method", "name": "files"}, {"url": "Url.common.html#method_find", "access": "", "host": "Url.common", "type": "method", "name": "find"}, {"url": "Intl.common.html#method_formatDate", "access": "", "host": "Intl.common", "type": "method", "name": "formatDate"}, {"url": "Cookie.server.html#method_get", "access": "", "host": "Cookie.server", "type": "method", "name": "get"}, {"url": "Config.common.html#method_get", "access": "", "host": "Config.common", "type": "method", "name": "get"}, {"url": "Params.common.html#method_getAll", "access": "", "host": "Params.common", "type": "method", "name": "getAll"}, {"url": "Config.common.html#method_getDefinition", "access": "", "host": "Config.common", "type": "method", "name": "getDefinition"}, {"url": "Params.common.html#method_getFromBody", "access": "", "host": "Params.common", "type": "method", "name": "getFromBody"}, {"url": "Params.common.html#method_getFromMerged", "access": "", "host": "Params.common", "type": "method", "name": "getFromMerged"}, {"url": "Params.common.html#method_getFromRoute", "access": "", "host": "Params.common", "type": "method", "name": "getFromRoute"}, {"url": "Params.common.html#method_getFromUrl", "access": "", "host": "Params.common", "type": "method", "name": "getFromUrl"}, {"url": "Http.server.html#method_getHeader", "access": "", "host": "Http.server", "type": "method", "name": "getHeader"}, {"url": "Http.server.html#method_getHeaders", "access": "", "host": "Http.server", "type": "method", "name": "getHeaders"}, {"url": "Http.server.html#method_getRequest", "access": "", "host": "Http.server", "type": "method", "name": "getRequest"}, {"url": "Http.server.html#method_getResponse", "access": "", "host": "Http.server", "type": "method", "name": "getResponse"}, {"url": "Partial.common.html#method_invoke", "access": "", "host": "Partial.common", "type": "method", "name": "invoke"}, {"url": "Http.server.html#method_isXhr", "access": "", "host": "Http.server", "type": "method", "name": "isXhr"}, {"url": "Intl.common.html#method_lang", "access": "", "host": "Intl.common", "type": "method", "name": "lang"}, {"url": "Url.common.html#method_make", "access": "", "host": "Url.common", "type": "method", "name": "make"}, {"url": "Params.common.html#method_merged", "access": "", "host": "Params.common", "type": "method", "name": "merged"}, {"url": "Http.server.html#method_redirect", "access": "", "host": "Http.server", "type": "method", "name": "redirect"}, {"url": "Partial.common.html#method_render", "access": "", "host": "Partial.common", "type": "method", "name": "render"}, {"url": "Params.common.html#method_route", "access": "", "host": "Params.common", "type": "method", "name": "route"}, {"url": "Cookie.server.html#method_set", "access": "", "host": "Cookie.server", "type": "method", "name": "set"}, {"url": "Http.server.html#method_setHeader", "access": "", "host": "Http.server", "type": "method", "name": "setHeader"}, {"url": "Http.server.html#method_setHeaders", "access": "", "host": "Http.server", "type": "method", "name": "setHeaders"}, {"url": "Params.common.html#method_url", "access": "", "host": "Params.common", "type": "method", "name": "url"}];
</script>
</body>
</html>
